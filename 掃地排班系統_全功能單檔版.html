<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æƒåœ°æ’ç­ç®¡ç†ç³»çµ±</title>
  <meta name="description" content="å…¬å¸æ¯æ—¥æ¸…æƒå€åŸŸæ™ºæ…§æ’ç­å·¥å…·">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+TC:wght@400;500;600;700;800&display=swap"
    rel="stylesheet">
  <style>
    /* assets/index.css â€” æƒåœ°æ’ç­ç³»çµ±è¨­è¨ˆç³»çµ± */

    /* â”€â”€â”€ CSS Custom Properties â”€â”€â”€ */
    :root {
      --bg-primary: #0f1117;
      --bg-secondary: #1a1d28;
      --bg-card: #222536;
      --bg-card-hover: #2a2e42;
      --bg-input: #181b26;
      --border-color: #2e3348;
      --border-focus: #6c63ff;
      --text-primary: #e8eaf0;
      --text-secondary: #8b8fa8;
      --text-muted: #5a5f7a;
      --accent: #6c63ff;
      --accent-hover: #7f78ff;
      --accent-glow: rgba(108, 99, 255, 0.25);
      --success: #34d399;
      --success-bg: rgba(52, 211, 153, 0.12);
      --warning: #fbbf24;
      --warning-bg: rgba(251, 191, 36, 0.12);
      --danger: #f87171;
      --danger-bg: rgba(248, 113, 113, 0.12);
      --info: #60a5fa;
      --info-bg: rgba(96, 165, 250, 0.12);
      --male-color: #60a5fa;
      --female-color: #f472b6;
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
      --radius-xl: 20px;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 8px 30px rgba(0, 0, 0, 0.5);
      --shadow-glow: 0 0 20px var(--accent-glow);
      --transition: 0.2s ease;
      --font-main: 'Inter', 'Noto Sans TC', system-ui, -apple-system, sans-serif;
      --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
    }

    /* â”€â”€â”€ Reset & Base â”€â”€â”€ */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      font-size: 15px;
      scroll-behavior: smooth;
    }

    body {
      font-family: var(--font-main);
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* â”€â”€â”€ App Shell â”€â”€â”€ */
    .app-container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px;
    }

    /* â”€â”€â”€ Header â”€â”€â”€ */
    .app-header {
      text-align: center;
      padding: 32px 0 24px;
    }

    .app-header h1 {
      font-size: 2rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--accent), #a78bfa, #f472b6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.02em;
    }

    .app-header .subtitle {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-top: 6px;
    }

    /* â”€â”€â”€ Tab Navigation â”€â”€â”€ */
    .tab-nav {
      display: flex;
      gap: 4px;
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: 4px;
      margin-bottom: 24px;
      overflow-x: auto;
    }

    .tab-btn {
      flex: 1;
      padding: 12px 16px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 0.9rem;
      font-weight: 600;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition);
      white-space: nowrap;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .tab-btn:hover {
      color: var(--text-primary);
      background: var(--bg-card);
    }

    .tab-btn.active {
      background: var(--accent);
      color: #fff;
      box-shadow: var(--shadow-glow);
    }

    .tab-btn .tab-icon {
      font-size: 1.1rem;
    }

    .tab-panel {
      display: none;
      animation: fadeSlideIn 0.3s ease;
    }

    .tab-panel.active {
      display: block;
    }

    @keyframes fadeSlideIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* â”€â”€â”€ Cards â”€â”€â”€ */
    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
      padding: 24px;
      margin-bottom: 16px;
      transition: all var(--transition);
    }

    .card:hover {
      border-color: rgba(108, 99, 255, 0.3);
      box-shadow: var(--shadow-sm);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 1.15rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title .icon {
      font-size: 1.3rem;
    }

    /* â”€â”€â”€ Buttons â”€â”€â”€ */
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: var(--radius-md);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-family: var(--font-main);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      color: #fff;
      box-shadow: var(--shadow-glow);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 30px var(--accent-glow);
    }

    .btn-success {
      background: var(--success);
      color: #0f1117;
    }

    .btn-success:hover {
      filter: brightness(1.1);
    }

    .btn-danger {
      background: var(--danger-bg);
      color: var(--danger);
      border: 1px solid rgba(248, 113, 113, 0.2);
    }

    .btn-danger:hover {
      background: rgba(248, 113, 113, 0.2);
    }

    .btn-outline {
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
    }

    .btn-outline:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .btn-sm {
      padding: 6px 14px;
      font-size: 0.8rem;
    }

    .btn-icon {
      width: 36px;
      height: 36px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-color);
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all var(--transition);
      font-size: 1rem;
    }

    .btn-icon:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-glow);
    }

    .btn-icon.danger:hover {
      border-color: var(--danger);
      color: var(--danger);
      background: var(--danger-bg);
    }

    /* â”€â”€â”€ Forms â”€â”€â”€ */
    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .form-input,
    .form-select {
      width: 100%;
      padding: 10px 14px;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 0.9rem;
      font-family: var(--font-main);
      transition: border-color var(--transition);
    }

    .form-input:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .form-select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238b8fa8' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .form-row-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }

    /* â”€â”€â”€ Checkbox List (å‡ºå‹¤å‹¾é¸) â”€â”€â”€ */
    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 8px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition);
      user-select: none;
    }

    .checkbox-item:hover {
      border-color: var(--accent);
      background: var(--bg-card-hover);
    }

    .checkbox-item.checked {
      border-color: var(--accent);
      background: var(--accent-glow);
    }

    .checkbox-item input[type="checkbox"] {
      display: none;
    }

    .checkbox-mark {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-color);
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition);
      flex-shrink: 0;
    }

    .checkbox-item.checked .checkbox-mark {
      background: var(--accent);
      border-color: var(--accent);
    }

    .checkbox-item.checked .checkbox-mark::after {
      content: 'âœ“';
      color: #fff;
      font-size: 0.75rem;
      font-weight: 700;
    }

    .checkbox-label {
      font-size: 0.9rem;
      font-weight: 500;
    }

    .gender-badge {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
      margin-left: auto;
    }

    .gender-badge.male {
      background: rgba(96, 165, 250, 0.15);
      color: var(--male-color);
    }

    .gender-badge.female {
      background: rgba(244, 114, 182, 0.15);
      color: var(--female-color);
    }

    /* â”€â”€â”€ Schedule Result â”€â”€â”€ */
    .schedule-result {
      margin-top: 20px;
    }

    .assignment-card {
      display: flex;
      align-items: center;
      padding: 14px 18px;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      margin-bottom: 8px;
      transition: all var(--transition);
    }

    .assignment-card:hover {
      background: var(--bg-card-hover);
      border-color: rgba(108, 99, 255, 0.2);
    }

    .assignment-area {
      font-weight: 700;
      min-width: 120px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .assignment-area .priority-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .priority-dot.daily {
      background: var(--success);
    }

    .priority-dot.flexible {
      background: var(--warning);
    }

    .priority-dot.optional {
      background: var(--info);
    }

    .assignment-staff {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-left: auto;
    }

    .staff-chip {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .staff-chip.male {
      background: rgba(96, 165, 250, 0.15);
      color: var(--male-color);
    }

    .staff-chip.female {
      background: rgba(244, 114, 182, 0.15);
      color: var(--female-color);
    }

    .staff-chip[draggable="true"] {
      cursor: grab;
    }

    .staff-chip[draggable="true"]:active {
      cursor: grabbing;
    }

    .staff-chip.dragging {
      opacity: 0.5;
      transform: scale(0.95);
    }

    .assignment-card.drag-over {
      border-color: var(--accent);
      background: var(--bg-card-hover);
      box-shadow: 0 0 10px var(--accent-glow);
    }

    .skipped-area {
      padding: 10px 18px;
      background: var(--warning-bg);
      border: 1px solid rgba(251, 191, 36, 0.15);
      border-radius: var(--radius-md);
      margin-bottom: 6px;
      color: var(--warning);
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .warning-item {
      padding: 8px 14px;
      background: var(--info-bg);
      border-radius: var(--radius-sm);
      margin-bottom: 6px;
      color: var(--info);
      font-size: 0.85rem;
    }

    /* â”€â”€â”€ Table â”€â”€â”€ */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }

    .data-table th {
      text-align: left;
      padding: 10px 14px;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border-color);
    }

    .data-table td {
      padding: 12px 14px;
      border-bottom: 1px solid rgba(46, 51, 72, 0.5);
      font-size: 0.9rem;
    }

    .data-table tr:hover td {
      background: var(--bg-card-hover);
    }

    .data-table .actions {
      display: flex;
      gap: 6px;
      justify-content: flex-end;
    }

    /* â”€â”€â”€ Status Badges â”€â”€â”€ */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .badge-success {
      background: var(--success-bg);
      color: var(--success);
    }

    .badge-warning {
      background: var(--warning-bg);
      color: var(--warning);
    }

    .badge-danger {
      background: var(--danger-bg);
      color: var(--danger);
    }

    .badge-info {
      background: var(--info-bg);
      color: var(--info);
    }

    /* â”€â”€â”€ Planner Info â”€â”€â”€ */
    .planner-banner {
      background: linear-gradient(135deg, rgba(108, 99, 255, 0.1), rgba(167, 139, 250, 0.08));
      border: 1px solid rgba(108, 99, 255, 0.25);
      border-radius: var(--radius-lg);
      padding: 18px 24px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .planner-banner .planner-icon {
      font-size: 2rem;
    }

    .planner-banner .planner-info h3 {
      font-size: 0.85rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .planner-banner .planner-info .planner-name {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--accent);
    }

    .planner-banner .planner-info .deputy-note {
      font-size: 0.8rem;
      color: var(--warning);
      margin-top: 2px;
    }

    /* â”€â”€â”€ Rotation List â”€â”€â”€ */
    .rotation-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .rotation-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 18px;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      transition: all var(--transition);
    }

    .rotation-item.current {
      border-color: var(--accent);
      background: var(--accent-glow);
    }

    .rotation-index {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: var(--bg-card);
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--text-muted);
    }

    .rotation-item.current .rotation-index {
      background: var(--accent);
      color: #fff;
    }

    .rotation-name {
      font-weight: 600;
    }

    .rotation-deputy {
      margin-left: auto;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* â”€â”€â”€ Modal â”€â”€â”€ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.25s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-xl);
      padding: 28px;
      width: 90%;
      max-width: 480px;
      max-height: 85vh;
      overflow-y: auto;
      transform: scale(0.95) translateY(10px);
      transition: transform 0.25s ease;
    }

    .modal-overlay.active .modal {
      transform: scale(1) translateY(0);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 1.15rem;
      font-weight: 700;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.3rem;
      cursor: pointer;
      padding: 4px;
      transition: color var(--transition);
    }

    .modal-close:hover {
      color: var(--text-primary);
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
    }

    /* â”€â”€â”€ Date Picker â”€â”€â”€ */
    .date-picker {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .date-picker input[type="date"] {
      padding: 10px 16px;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 1rem;
      font-family: var(--font-main);
      font-weight: 600;
    }

    .date-picker input[type="date"]:focus {
      outline: none;
      border-color: var(--border-focus);
    }

    .date-picker input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(0.7);
    }

    /* â”€â”€â”€ Stats â”€â”€â”€ */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 14px;
      text-align: center;
    }

    .stat-value {
      font-size: 1.6rem;
      font-weight: 800;
      color: var(--accent);
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 2px;
    }

    /* â”€â”€â”€ Toast â”€â”€â”€ */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .toast {
      padding: 12px 20px;
      border-radius: var(--radius-md);
      font-size: 0.85rem;
      font-weight: 600;
      color: #fff;
      box-shadow: var(--shadow-lg);
      animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
      max-width: 360px;
    }

    .toast.success {
      background: #059669;
    }

    .toast.error {
      background: #dc2626;
    }

    .toast.info {
      background: #2563eb;
    }

    @keyframes toastIn {
      from {
        opacity: 0;
        transform: translateX(30px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes toastOut {
      from {
        opacity: 1;
        transform: translateX(0);
      }

      to {
        opacity: 0;
        transform: translateX(30px);
      }
    }

    /* â”€â”€â”€ Toolbar â”€â”€â”€ */
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 16px;
    }

    .toolbar-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* â”€â”€â”€ Empty State â”€â”€â”€ */
    .empty-state {
      text-align: center;
      padding: 48px 20px;
      color: var(--text-muted);
    }

    .empty-state .empty-icon {
      font-size: 3rem;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .empty-state p {
      font-size: 0.9rem;
    }

    /* â”€â”€â”€ Print â”€â”€â”€ */
    @media print {
      body {
        background: #fff;
        color: #000;
      }

      .app-header,
      .tab-nav,
      .toolbar,
      .btn,
      .toast-container,
      .modal-overlay {
        display: none !important;
      }

      .tab-panel {
        display: block !important;
      }

      .card {
        border: 1px solid #ccc;
        box-shadow: none;
        background: #fff;
      }

      .assignment-card {
        background: #f9f9f9;
        border-color: #ddd;
      }

      .staff-chip {
        background: #eee;
        color: #333;
      }

      .schedule-result {
        page-break-inside: avoid;
      }
    }

    /* â”€â”€â”€ Responsive â”€â”€â”€ */
    @media (max-width: 768px) {
      html {
        font-size: 14px;
      }

      .app-container {
        padding: 12px;
      }

      .tab-nav {
        overflow-x: auto;
        flex-wrap: nowrap;
      }

      .tab-btn {
        padding: 10px 12px;
        font-size: 0.82rem;
      }

      .form-row,
      .form-row-3 {
        grid-template-columns: 1fr;
      }

      .checkbox-grid {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      }

      .assignment-card {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .assignment-staff {
        margin-left: 0;
      }

      .stats-row {
        grid-template-columns: repeat(2, 1fr);
      }

      .planner-banner {
        flex-direction: column;
        text-align: center;
      }

      .data-table {
        font-size: 0.8rem;
      }

      .data-table th,
      .data-table td {
        padding: 8px 10px;
      }
    }

    /* â”€â”€â”€ History â”€â”€â”€ */
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 400px;
      overflow-y: auto;
    }

    .history-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      background: var(--bg-input);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition);
    }

    .history-item:hover {
      background: var(--bg-card-hover);
      border-color: var(--accent);
    }

    .history-date {
      font-weight: 700;
      font-size: 0.9rem;
    }

    .history-summary {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    /* â”€â”€â”€ Scrollbar â”€â”€â”€ */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* â”€â”€â”€ Select All Button â”€â”€â”€ */
    .select-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
  </style>
  <style>
    /* è®“äººå“¡åˆ†çµ„æ›´æ˜é¡¯çš„æ¨£å¼ */
    .dept-group {
      break-inside: avoid;
    }
  </style>
</head>

<body>

  <div class="app-container">
    <!-- â”€â”€â”€ Header â”€â”€â”€ -->
    <header class="app-header">
      <h1>ğŸ§¹ æƒåœ°æ’ç­ç®¡ç†ç³»çµ± <span
          style="font-size:0.8rem; font-weight:400; opacity:0.7; border:1px solid; padding:2px 6px; border-radius:4px; vertical-align:middle; margin-left:8px;">V9.0</span>
      </h1>
      <p class="subtitle">æ¯æ—¥æ¸…æƒå€åŸŸæ™ºæ…§æ’ç­ Â· ç©ºé–“å„ªå…ˆå¢æ´ Â· è·¨è¨­å‚™ä¸€è‡´ (Seed V8)</p>
    </header>

    <!-- â”€â”€â”€ Tab Navigation â”€â”€â”€ -->
    <nav class="tab-nav" id="tabNav">
      <button class="tab-btn active" data-tab="schedule">
        <span class="tab-icon">ğŸ“‹</span> æ¯æ—¥æ’ç­
      </button>
      <button class="tab-btn" data-tab="staff">
        <span class="tab-icon">ğŸ‘¥</span> äººå“¡ç®¡ç†
      </button>
      <button class="tab-btn" data-tab="areas">
        <span class="tab-icon">ğŸ¢</span> å€åŸŸç®¡ç†
      </button>
      <button class="tab-btn" data-tab="rotation">
        <span class="tab-icon">ğŸ”„</span> è¼ªå€¼è¨­å®š
      </button>
      <button class="tab-btn" data-tab="history">
        <span class="tab-icon">ğŸ“œ</span> æ­·å²ç´€éŒ„
      </button>
      <button class="tab-btn" data-tab="settings">
        <span class="tab-icon">âš™ï¸</span> è³‡æ–™ç®¡ç†
      </button>
    </nav>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- TAB 1: æ¯æ—¥æ’ç­ -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="tab-panel active" id="panel-schedule">
      <!-- è² è²¬äººè³‡è¨Š -->
      <div class="planner-banner" id="plannerBanner">
        <span class="planner-icon">ğŸ‘¤</span>
        <div class="planner-info">
          <h3>æœ¬é€±æ’ç­è² è²¬äºº</h3>
          <div class="planner-name" id="plannerName">è¼‰å…¥ä¸­...</div>
          <div class="deputy-note" id="deputyNote" style="display:none;"></div>
          <div style="font-size:0.75rem;color:var(--text-muted);margin-top:2px;">â€» æ’ç­è² è²¬äººä¸åƒèˆ‡æƒåœ°</div>
        </div>
      </div>

      <!-- æ—¥æœŸ + é¸é … -->
      <div class="card">
        <div class="card-header">
          <div class="card-title"><span class="icon">ğŸ“…</span> æ—¥æœŸèˆ‡é¸é …</div>
        </div>
        <div class="date-picker" style="margin-bottom:16px;">
          <input type="date" id="scheduleDate">
          <button class="btn btn-outline btn-sm" id="todayBtn">ä»Šå¤©</button>
        </div>
        <!-- éš”å¤©æ”¾å‡ -->
        <label class="checkbox-item" style="max-width:220px;margin-bottom:12px;" id="holidayLabel">
          <input type="checkbox" id="holidayToggle">
          <span class="checkbox-mark"></span>
          <span class="checkbox-label">ğŸ–ï¸ éš”å¤©æ”¾å‡ï¼ˆâ‘£é™½å°+1äººï¼‰</span>
        </label>
        <!-- å¯é¸å€åŸŸ -->
        <div style="margin-top:4px;">
          <div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:6px;font-weight:600;">ğŸ”µ
            å¯é¸å€åŸŸï¼ˆå·²é è¨­å‹¾é¸ï¼Œå¯æ‰‹å‹•æ’é™¤ï¼‰</div>
          <div class="checkbox-grid" id="optionalToggles" style="gap:6px;"></div>
        </div>
      </div>

      <!-- å‡ºå‹¤äººå“¡ -->
      <div class="card">
        <div class="card-header">
          <div class="card-title"><span class="icon">âœ…</span> ä»Šæ—¥å‡ºå‹¤äººå“¡ï¼ˆä¾éƒ¨é–€ï¼‰</div>
          <div class="select-controls">
            <button class="btn btn-outline btn-sm" id="selectDefaultStaff">é è¨­</button>
            <button class="btn btn-outline btn-sm" id="selectAllStaff">å…¨é¸</button>
            <button class="btn btn-outline btn-sm" id="deselectAllStaff">å…¨ä¸é¸</button>
          </div>
        </div>
        <!-- æ”¹ç‚º Block Display ä»¥æ”¯æ´æ¨™é¡Œ -->
        <div id="staffCheckboxes" style="display:flex; flex-wrap:wrap; gap:16px;"></div>

        <div class="stats-row" style="margin-top: 16px;">
          <div class="stat-card">
            <div class="stat-value" id="presentCount">0</div>
            <div class="stat-label">ä»Šæ—¥å‡ºå‹¤</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="maleCount">0</div>
            <div class="stat-label">ç”·æ€§</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="femaleCount">0</div>
            <div class="stat-label">å¥³æ€§</div>
          </div>
        </div>
      </div>

      <!-- æ’ç­æ“ä½œ -->
      <div class="toolbar">
        <button class="btn btn-primary" id="generateBtn">ğŸ² è‡ªå‹•æ’ç­</button>
        <div class="toolbar-actions">
          <button class="btn btn-success btn-sm" id="saveScheduleBtn" style="display:none;">ğŸ’¾ å„²å­˜æ’ç­</button>
          <button class="btn btn-outline btn-sm" id="addLateBtn" style="display:none;">ğŸƒ è¿½åŠ äººå“¡</button>
          <button class="btn btn-outline btn-sm" id="printBtn" style="display:none;">ğŸ–¨ï¸ åˆ—å°</button>
        </div>
      </div>

      <!-- æ’ç­çµæœ -->
      <div class="schedule-result" id="scheduleResult"></div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- TAB 2: äººå“¡ç®¡ç† -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="tab-panel" id="panel-staff">
      <div class="toolbar">
        <div class="card-title"><span class="icon">ğŸ‘¥</span> äººå“¡ç®¡ç†</div>
        <button class="btn btn-primary btn-sm" id="addStaffBtn">ï¼‹ æ–°å¢äººå“¡</button>
      </div>
      <div class="card" style="padding: 0; overflow-x: auto;">
        <table class="data-table" id="staffTable">
          <thead>
            <tr>
              <th>éƒ¨é–€</th>
              <th>å§“å</th>
              <th>æ€§åˆ¥</th>
              <th>è§’è‰²</th>
              <th>ç‹€æ…‹</th>
              <th>é è¨­å‡ºå‹¤</th>
              <th style="text-align:right;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="staffTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- å…¶é¤˜ TAB ä¿æŒä¸è®Š (ç•¥) -->
    <div class="tab-panel" id="panel-areas">
      <div class="toolbar">
        <div class="card-title"><span class="icon">ğŸ¢</span> å€åŸŸç®¡ç†</div>
        <button class="btn btn-primary btn-sm" id="addAreaBtn">ï¼‹ æ–°å¢å€åŸŸ</button>
      </div>
      <div class="card" style="padding: 0; overflow-x: auto;">
        <table class="data-table" id="areaTable">
          <thead>
            <tr>
              <th>å€åŸŸåç¨±</th>
              <th>æ¨“å±¤</th>
              <th>å„ªå…ˆç´š</th>
              <th>æ€§åˆ¥é™å®š</th>
              <th>äººæ•¸</th>
              <th style="text-align:right;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="areaTableBody"></tbody>
        </table>
      </div>
    </div>

    <div class="tab-panel" id="panel-rotation">
      <div class="card">
        <div class="card-header">
          <div class="card-title"><span class="icon">ğŸ”„</span> æ¯é€±è² è²¬äººè¼ªå€¼é †åº</div>
          <div class="toolbar-actions">
            <button class="btn btn-outline btn-sm" id="advanceWeekBtn">â© æ¨é€²ä¸‹ä¸€é€±</button>
          </div>
        </div>
        <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:12px;">ä»£ç†äºº = è¼ªå€¼è¡¨ä¸­ä¸‹ä¸€ä½æœ‰å‡ºå‹¤çš„äººã€‚é»æ“Šå¯åˆ‡æ›æœ¬é€±è² è²¬äººã€‚</p>
        <div class="rotation-list" id="rotationList"></div>
      </div>
    </div>

    <div class="tab-panel" id="panel-history">
      <div class="card">
        <div class="card-header">
          <div class="card-title"><span class="icon">ğŸ“œ</span> æ’ç­æ­·å²ç´€éŒ„</div>
        </div>
        <div class="history-list" id="historyList"></div>
      </div>
    </div>

    <div class="tab-panel" id="panel-settings">
      <div class="card">
        <div class="card-header">
          <div class="card-title"><span class="icon">ğŸ’¾</span> è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ</div>
        </div>
        <div class="toolbar-actions" style="gap:10px;">
          <button class="btn btn-primary btn-sm" id="exportBtn">ğŸ“¤ åŒ¯å‡º JSON</button>
          <button class="btn btn-outline btn-sm" id="importBtn">ğŸ“¥ åŒ¯å…¥ JSON</button>
          <input type="file" id="importFile" accept=".json" style="display:none;">
        </div>
      </div>
      <div class="card" style="margin-top:16px;">
        <div class="card-header">
          <div class="card-title"><span class="icon">ğŸ—‘ï¸</span> å±éšªæ“ä½œ</div>
        </div>
        <p style="color:var(--text-secondary);font-size:0.85rem;margin-bottom:14px;">æ¸…é™¤æ‰€æœ‰è³‡æ–™å°‡ç„¡æ³•å¾©åŸï¼Œè«‹å…ˆåŒ¯å‡ºå‚™ä»½ã€‚</p>
        <button class="btn btn-danger btn-sm" id="clearAllBtn">âš ï¸ æ¸…é™¤å…¨éƒ¨è³‡æ–™</button>
      </div>
      <div class="card" style="margin-top:16px;">
        <div class="card-header">
          <div class="card-title"><span class="icon">ğŸ”„</span> é‡æ–°è¼‰å…¥é è¨­è³‡æ–™</div>
        </div>
        <p style="color:var(--text-secondary);font-size:0.85rem;margin-bottom:14px;">æ¸…é™¤ç¾æœ‰è³‡æ–™å¾Œè¼‰å…¥åŸå§‹äººå“¡èˆ‡å€åŸŸè¨­å®šã€‚</p>
        <button class="btn btn-outline btn-sm" id="resetDefaultBtn">é‡ç½®ç‚ºé è¨­</button>
      </div>
    </div>
  </div>

  <!-- â”€â”€â”€ Modal â”€â”€â”€ -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal" id="modalContent"></div>
  </div>

  <!-- â”€â”€â”€ Toast â”€â”€â”€ -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- â”€â”€â”€ Scripts â”€â”€â”€ -->
  <script>
    const INLINE_DEFAULT_DATA = {
      "staff": [
        {
          "id": "s01",
          "name": "å¼µæ›¸å‹",
          "gender": "male",
          "active": true,
          "isDefault": false,
          "role": "manager",
          "floorRestriction": null,
          "excludeAreas": [],
          "department": "æŠ€è¡“éƒ¨"
        },
        {
          "id": "s02",
          "name": "èŠé”å¯Œ",
          "gender": "male",
          "active": true,
          "isDefault": true,
          "role": "regular",
          "floorRestriction": null,
          "excludeAreas": [],
          "department": "æŠ€è¡“éƒ¨"
        },
        {
          "id": "s03",
          "name": "è¨±æƒ è‹±",
          "gender": "female",
          "active": true,
          "isDefault": false,
          "role": "manager",
          "floorRestriction": null,
          "excludeAreas": [],
          "department": "ç®¡ç†éƒ¨"
        },
        {
          "id": "s04",
          "name": "é¡å®å…‰",
          "gender": "male",
          "active": true,
          "isDefault": true,
          "role": "regular",
          "floorRestriction": null,
          "excludeAreas": [],
          "department": "æŠ€è¡“éƒ¨"
        },
        {
          "id": "s05",
          "name": "é‚±æŒ¯å¨",
          "gender": "male",
          "active": true,
          "isDefault": true,
          "role": "regular",
          "floorRestriction": null,
          "excludeAreas": [],
          "department": "æŠ€è¡“éƒ¨"
        },
        {
          "id": "s06",
          "name": "è­šæ–‡ç”·",
          "gender": "male",
          "active": true,
          "isDefault": true,
          "role": "regular",
          "floorRestriction": null,
          "excludeAreas": [],
          "department": "æŠ€è¡“éƒ¨"
        },
        {
          "id": "s07",
          "name": "æ¥Šéº—ç‰",
          "gender": "female",
          "active": true,
          "isDefault": true,
          "role": "regular",
          "floorRestriction": null,
          "excludeAreas": [],
          "department": "ç®¡ç†éƒ¨"
        },
        {
          "id": "s08",
          "name": "æ±Ÿè¾°å¹³",
          "gender": "female",
          "active": true,
          "isDefault": true,
          "role": "regular",
          "floorRestriction": null,
          "excludeAreas": [],
          "department": "ç®¡ç†éƒ¨"
        },
        {
          "id": "s09",
          "name": "é™³é€¸äºº",
          "gender": "male",
          "active": true,
          "isDefault": false,
          "role": "manager",
          "floorRestriction": null,
          "excludeAreas": [],
          "department": "ç‡Ÿæ¥­éƒ¨"
        },
        {
          "id": "s10",
          "name": "é»ƒè–æ–‡",
          "gender": "female",
          "active": true,
          "isDefault": true,
          "role": "regular",
          "floorRestriction": null,
          "excludeAreas": [],
          "department": "ç‡Ÿæ¥­éƒ¨"
        },
        {
          "id": "s11",
          "name": "é»ƒç®çŠ",
          "gender": "female",
          "active": true,
          "isDefault": true,
          "role": "regular",
          "floorRestriction": null,
          "excludeAreas": [],
          "department": "ç®¡ç†éƒ¨"
        },
        {
          "id": "s12",
          "name": "é»ƒæ™ºå‚‘",
          "gender": "male",
          "active": true,
          "isDefault": true,
          "role": "regular",
          "floorRestriction": null,
          "excludeAreas": [],
          "department": "æŠ€è¡“éƒ¨"
        },
        {
          "id": "s13",
          "name": "é™³ç‘é›¯",
          "gender": "female",
          "active": true,
          "isDefault": true,
          "role": "regular",
          "floorRestriction": null,
          "excludeAreas": [],
          "department": "ç‡Ÿæ¥­éƒ¨"
        },
        {
          "id": "s14",
          "name": "èŒƒå­æ…ˆ",
          "gender": "female",
          "active": true,
          "isDefault": true,
          "role": "regular",
          "floorRestriction": null,
          "excludeAreas": [],
          "department": "ç®¡ç†éƒ¨"
        },
        {
          "id": "s15",
          "name": "ææ‰¿å“²",
          "gender": "male",
          "active": true,
          "isDefault": true,
          "role": "regular",
          "floorRestriction": null,
          "excludeAreas": [],
          "department": "æŠ€è¡“éƒ¨"
        },
        {
          "id": "s16",
          "name": "è¨±æ¼¢å¾·",
          "gender": "male",
          "active": true,
          "isDefault": true,
          "role": "regular",
          "floorRestriction": null,
          "excludeAreas": [],
          "department": "æŠ€è¡“éƒ¨"
        },
        {
          "id": "s17",
          "name": "æå“²æ—­",
          "gender": "male",
          "active": true,
          "isDefault": true,
          "role": "regular",
          "floorRestriction": null,
          "excludeAreas": [],
          "department": "æŠ€è¡“éƒ¨"
        },
        {
          "id": "s18",
          "name": "é™³å¦æ·‡",
          "gender": "female",
          "active": true,
          "isDefault": true,
          "role": "regular",
          "floorRestriction": null,
          "excludeAreas": [],
          "department": "ç®¡ç†éƒ¨"
        },
        {
          "id": "s19",
          "name": "æ´ªç«‹æ©",
          "gender": "male",
          "active": true,
          "isDefault": true,
          "role": "regular",
          "floorRestriction": null,
          "excludeAreas": [],
          "department": "ç‡Ÿæ¥­éƒ¨"
        },
        {
          "id": "s20",
          "name": "ç°¡é´»å½¬",
          "gender": "male",
          "active": true,
          "isDefault": true,
          "role": "regular",
          "floorRestriction": null,
          "excludeAreas": [],
          "department": "æŠ€è¡“éƒ¨"
        },
        {
          "id": "s21",
          "name": "è”¡æ²›å®¹",
          "gender": "female",
          "active": true,
          "isDefault": true,
          "role": "regular",
          "floorRestriction": null,
          "excludeAreas": [],
          "department": "ç‡Ÿæ¥­éƒ¨"
        },
        {
          "id": "s22",
          "name": "å¼µèŠ®æº±",
          "gender": "female",
          "active": true,
          "isDefault": true,
          "role": "regular",
          "floorRestriction": 2,
          "excludeAreas": [
            "a4"
          ],
          "department": "ç®¡ç†éƒ¨"
        },
        {
          "id": "s23",
          "name": "æ—è–å®¶",
          "gender": "male",
          "active": true,
          "isDefault": true,
          "role": "regular",
          "floorRestriction": null,
          "excludeAreas": [],
          "department": "æ–°äº‹æ¥­éƒ¨"
        },
        {
          "id": "s24",
          "name": "å¾æ˜å„„",
          "gender": "male",
          "active": true,
          "isDefault": true,
          "role": "regular",
          "floorRestriction": null,
          "excludeAreas": [],
          "department": "æŠ€è¡“éƒ¨"
        },
        {
          "id": "s25",
          "name": "è–›è‚²æ”¿",
          "gender": "male",
          "active": true,
          "isDefault": true,
          "role": "regular",
          "floorRestriction": null,
          "excludeAreas": [],
          "department": "æŠ€è¡“éƒ¨"
        },
        {
          "id": "s26",
          "name": "æ—é‚—æ½",
          "gender": "male",
          "active": true,
          "isDefault": true,
          "role": "regular",
          "floorRestriction": null,
          "excludeAreas": [],
          "department": "æŠ€è¡“éƒ¨"
        },
        {
          "id": "s27",
          "name": "å¼µæ±è¯",
          "gender": "female",
          "active": true,
          "isDefault": true,
          "role": "regular",
          "floorRestriction": null,
          "excludeAreas": [],
          "department": "æ–°äº‹æ¥­éƒ¨"
        },
        {
          "id": "s28",
          "name": "å§šé¦™å‡",
          "gender": "female",
          "active": true,
          "isDefault": true,
          "role": "regular",
          "floorRestriction": null,
          "excludeAreas": [],
          "department": "æ–°äº‹æ¥­éƒ¨"
        }
      ],
      "areas": [
        {
          "id": "a1",
          "name": "2æ¨“_å»šæˆ¿",
          "floor": 2,
          "priority": "daily",
          "genderRestriction": "female",
          "minPeople": 1,
          "maxPeople": 2,
          "order": 1,
          "holidayBoost": false
        },
        {
          "id": "a2",
          "name": "2æ¨“_å¥³å»",
          "floor": 2,
          "priority": "daily",
          "genderRestriction": "female",
          "minPeople": 1,
          "maxPeople": 2,
          "order": 2,
          "holidayBoost": false
        },
        {
          "id": "a3",
          "name": "2æ¨“_ç”·å»",
          "floor": 2,
          "priority": "daily",
          "genderRestriction": "malePreferred",
          "minPeople": 1,
          "maxPeople": 2,
          "order": 3,
          "holidayBoost": false
        },
        {
          "id": "a4",
          "name": "2æ¨“_é™½å°",
          "floor": 2,
          "priority": "daily",
          "genderRestriction": "malePreferred",
          "minPeople": 1,
          "maxPeople": 4,
          "order": 4,
          "holidayBoost": true
        },
        {
          "id": "a5",
          "name": "1æ¨“_é£Ÿå ‚",
          "floor": 1,
          "priority": "daily",
          "genderRestriction": "none",
          "minPeople": 1,
          "maxPeople": 1,
          "order": 5,
          "holidayBoost": false
        },
        {
          "id": "a6",
          "name": "1æ¨“_ç”·å»",
          "floor": 1,
          "priority": "daily",
          "genderRestriction": "malePreferred",
          "minPeople": 1,
          "maxPeople": 2,
          "order": 6,
          "holidayBoost": false
        },
        {
          "id": "a7",
          "name": "1æ¨“_å¥³å»",
          "floor": 1,
          "priority": "daily",
          "genderRestriction": "female",
          "minPeople": 1,
          "maxPeople": 2,
          "order": 7,
          "holidayBoost": false
        },
        {
          "id": "a8",
          "name": "2æ¨“_èµ°å»Šã€ç„é—œã€æ‡‰æ¥å®¤",
          "floor": 2,
          "priority": "flexible",
          "genderRestriction": "none",
          "minPeople": 1,
          "maxPeople": 1,
          "order": 8,
          "holidayBoost": false
        },
        {
          "id": "a9",
          "name": "2æ¨“_äº‹å‹™æ‰€å…¨å€",
          "floor": 2,
          "priority": "flexible",
          "genderRestriction": "none",
          "minPeople": 1,
          "maxPeople": 6,
          "order": 9,
          "holidayBoost": false
        },
        {
          "id": "a10",
          "name": "2æ¨“_å¤šç›®çš„å®¤",
          "floor": 2,
          "priority": "optional",
          "genderRestriction": "none",
          "minPeople": 1,
          "maxPeople": 1,
          "order": 10,
          "holidayBoost": false
        },
        {
          "id": "a11",
          "name": "1æ¨“_é™½å°",
          "floor": 1,
          "priority": "flexible",
          "genderRestriction": "none",
          "minPeople": 1,
          "maxPeople": 1,
          "order": 11,
          "holidayBoost": false
        },
        {
          "id": "a12",
          "name": "1æ¨“_æœƒè­°å®¤1",
          "floor": 1,
          "priority": "optional",
          "genderRestriction": "none",
          "minPeople": 1,
          "maxPeople": 1,
          "order": 12,
          "holidayBoost": false
        },
        {
          "id": "a13",
          "name": "1æ¨“_èµ°å»Š",
          "floor": 1,
          "priority": "flexible",
          "genderRestriction": "none",
          "minPeople": 1,
          "maxPeople": 1,
          "order": 13,
          "holidayBoost": false
        },
        {
          "id": "a14",
          "name": "1~2æ¨“_æ¨“æ¢¯",
          "floor": 0,
          "priority": "flexible",
          "genderRestriction": "none",
          "minPeople": 1,
          "maxPeople": 1,
          "order": 14,
          "holidayBoost": false
        },
        {
          "id": "a15",
          "name": "1æ¨“_ç„¡å¡µå®¤æ›´è¡£å®¤",
          "floor": 1,
          "priority": "flexible",
          "genderRestriction": "none",
          "minPeople": 1,
          "maxPeople": 1,
          "order": 15,
          "holidayBoost": false
        },
        {
          "id": "a16",
          "name": "1æ¨“_å¥³å­æ›´è¡£å®¤",
          "floor": 1,
          "priority": "flexible",
          "genderRestriction": "female",
          "minPeople": 1,
          "maxPeople": 1,
          "order": 16,
          "holidayBoost": false
        }
      ],
      "plannerRotation": {
        "planners": [
          "s11",
          "s07",
          "s08",
          "s14",
          "s18",
          "s22",
          "s10",
          "s13",
          "s19",
          "s21",
          "s23",
          "s27",
          "s28",
          "s06",
          "s05",
          "s02",
          "s04",
          "s12",
          "s15",
          "s16",
          "s17",
          "s20",
          "s24",
          "s25",
          "s26"
        ],
        "currentIndex": 0
      }
    };
    function initializeInlineData() {
      const STORAGE_KEYS = {
        STAFF: 'cleaning_staff',
        AREAS: 'cleaning_areas',
        PLANNER: 'cleaning_planner_rotation',
        SCHEDULES: 'cleaning_schedules',
        DATA_VER: 'cleaning_data_version',
      };
      const DATA_VERSION = 9;

      const savedVer = localStorage.getItem(STORAGE_KEYS.DATA_VER);

      // å¦‚æœç‰ˆæœ¬ä¸ç¬¦æˆ–å®Œå…¨æ²’è³‡æ–™
      if (!savedVer || parseInt(savedVer) < DATA_VERSION) {
        console.log('å–®æª”ç‰ˆåˆå§‹åŒ–æˆ–ç‰ˆæœ¬å‡ç´š (v' + (savedVer || 0) + ' -> v' + DATA_VERSION + ')');
        // å¦‚æœæ˜¯å‡ç´šä¸”åŸæœ¬æœ‰äººå“¡è³‡æ–™ï¼Œå¯ä»¥è€ƒæ…®ä¿ç•™ï¼Œä½†ç‚ºäº†å®‰å…¨æˆ‘å€‘å…ˆæ¸…ç©ºï¼ˆå› ç‰ˆæœ¬å‡ç´šé€šå¸¸æ¶‰åŠ schema è®Šå‹•ï¼‰
        // æˆ–è€…æˆ‘å€‘åªåœ¨å®Œå…¨æ²’è³‡æ–™æ™‚æ‰åˆå§‹åŒ–
        if (!savedVer || parseInt(savedVer) < DATA_VERSION) {
          Object.values(STORAGE_KEYS).forEach(k => localStorage.removeItem(k));
        }
      }

      const existingStaff = localStorage.getItem(STORAGE_KEYS.STAFF);
      if (!existingStaff || JSON.parse(existingStaff).length === 0) {
        if (INLINE_DEFAULT_DATA.staff) localStorage.setItem(STORAGE_KEYS.STAFF, JSON.stringify(INLINE_DEFAULT_DATA.staff));
        if (INLINE_DEFAULT_DATA.areas) localStorage.setItem(STORAGE_KEYS.AREAS, JSON.stringify(INLINE_DEFAULT_DATA.areas));
        if (INLINE_DEFAULT_DATA.plannerRotation) localStorage.setItem(STORAGE_KEYS.PLANNER, JSON.stringify(INLINE_DEFAULT_DATA.plannerRotation));
        localStorage.setItem(STORAGE_KEYS.DATA_VER, String(DATA_VERSION));
        console.log('å–®æª”ç‰ˆå·²è¼‰å…¥å…§åµŒé è¨­è³‡æ–™');
      }
    }
    // program/models.js â€” è³‡æ–™æ¨¡å‹èˆ‡ localStorage å­˜å–å±¤

    const DATA_VERSION = 9; // v9: æ›´æ­£é»ƒç®çŠéƒ¨é–€ã€å¼µæ±è¯æ’åºèª¿æ•´

    const STORAGE_KEYS = {
      STAFF: 'cleaning_staff',
      AREAS: 'cleaning_areas',
      PLANNER: 'cleaning_planner_rotation',
      SCHEDULES: 'cleaning_schedules',
      DATA_VER: 'cleaning_data_version',
    };

    // â”€â”€â”€ UUID ç”¢ç”Ÿå™¨ â”€â”€â”€
    function generateId() {
      return 'id_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 8);
    }

    // â”€â”€â”€ é€šç”¨ localStorage æ“ä½œ â”€â”€â”€
    function loadData(key, fallback = []) {
      try {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : fallback;
      } catch {
        return fallback;
      }
    }

    function saveData(key, data) {
      localStorage.setItem(key, JSON.stringify(data));
    }

    // â”€â”€â”€ Staff CRUD â”€â”€â”€
    const StaffModel = {
      getAll() {
        return loadData(STORAGE_KEYS.STAFF, []);
      },

      getActive() {
        return this.getAll().filter(s => s.active);
      },

      getById(id) {
        return this.getAll().find(s => s.id === id) || null;
      },

      add(staff) {
        const list = this.getAll();
        const newStaff = {
          id: generateId(),
          name: staff.name,
          gender: staff.gender || 'male',
          active: staff.active !== undefined ? staff.active : true,
          isDefault: staff.isDefault !== undefined ? staff.isDefault : true,
          role: staff.role || 'regular',
          floorRestriction: staff.floorRestriction || null,
          excludeAreas: staff.excludeAreas || [],
          department: staff.department || 'æœªåˆ†é¡',
        };
        list.push(newStaff);
        saveData(STORAGE_KEYS.STAFF, list);
        return newStaff;
      },

      update(id, updates) {
        const list = this.getAll();
        const idx = list.findIndex(s => s.id === id);
        if (idx === -1) return null;
        list[idx] = { ...list[idx], ...updates };
        saveData(STORAGE_KEYS.STAFF, list);
        return list[idx];
      },

      remove(id) {
        const list = this.getAll().filter(s => s.id !== id);
        saveData(STORAGE_KEYS.STAFF, list);
      },

      save(list) {
        saveData(STORAGE_KEYS.STAFF, list);
      },
    };

    // â”€â”€â”€ Area CRUD â”€â”€â”€
    const AreaModel = {
      getAll() {
        return loadData(STORAGE_KEYS.AREAS, []).sort((a, b) => a.order - b.order);
      },

      getById(id) {
        return this.getAll().find(a => a.id === id) || null;
      },

      add(area) {
        const list = this.getAll();
        const newArea = {
          id: generateId(),
          name: area.name,
          priority: area.priority || 'daily',
          genderRestriction: area.genderRestriction || 'none',
          minPeople: area.minPeople || 1,
          maxPeople: area.maxPeople || 1,
          order: area.order || list.length + 1,
          floor: area.floor !== undefined ? area.floor : 0,
          holidayBoost: area.holidayBoost || false,
        };
        list.push(newArea);
        saveData(STORAGE_KEYS.AREAS, list);
        return newArea;
      },

      update(id, updates) {
        const list = this.getAll();
        const idx = list.findIndex(a => a.id === id);
        if (idx === -1) return null;
        list[idx] = { ...list[idx], ...updates };
        saveData(STORAGE_KEYS.AREAS, list);
        return list[idx];
      },

      remove(id) {
        const list = this.getAll().filter(a => a.id !== id);
        saveData(STORAGE_KEYS.AREAS, list);
      },

      save(list) {
        saveData(STORAGE_KEYS.AREAS, list);
      },
    };

    // â”€â”€â”€ Planner Rotation â”€â”€â”€
    const PlannerModel = {
      get() {
        return loadData(STORAGE_KEYS.PLANNER, {
          planners: [],
          currentIndex: 0,
        });
      },

      save(data) {
        saveData(STORAGE_KEYS.PLANNER, data);
      },

      getCurrentPlanner(presentStaffIds = null) {
        const rot = this.get();
        if (rot.planners.length === 0) return null;
        const idx = rot.currentIndex % rot.planners.length;
        const plannerId = rot.planners[idx];

        if (presentStaffIds && !presentStaffIds.includes(plannerId)) {
          for (let i = 1; i < rot.planners.length; i++) {
            const nextIdx = (idx + i) % rot.planners.length;
            const nextId = rot.planners[nextIdx];
            if (presentStaffIds.includes(nextId)) {
              return { id: nextId, isDeputy: true, originalId: plannerId };
            }
          }
          return null;
        }

        return { id: plannerId, isDeputy: false, originalId: plannerId };
      },

      advanceWeek() {
        const rot = this.get();
        if (rot.planners.length === 0) return;
        rot.currentIndex = (rot.currentIndex + 1) % rot.planners.length;
        this.save(rot);
      },
    };

    // â”€â”€â”€ Schedule Records â”€â”€â”€
    const ScheduleModel = {
      getAll() {
        return loadData(STORAGE_KEYS.SCHEDULES, []);
      },

      getByDate(dateStr) {
        return this.getAll().find(s => s.date === dateStr) || null;
      },

      save(schedule) {
        const list = this.getAll().filter(s => s.date !== schedule.date);
        list.push(schedule);
        list.sort((a, b) => b.date.localeCompare(a.date));
        saveData(STORAGE_KEYS.SCHEDULES, list);
      },

      remove(dateStr) {
        const list = this.getAll().filter(s => s.date !== dateStr);
        saveData(STORAGE_KEYS.SCHEDULES, list);
      },

      getRecent(n = 30) {
        return this.getAll().slice(0, n);
      },
    };

    // â”€â”€â”€ å…¬å¹³æ€§ + å€åŸŸæ­·å² â”€â”€â”€
    const HistoryModel = {
      getAssignmentCounts(days = 14) {
        const schedules = ScheduleModel.getAll();
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - days);
        const cutoffStr = cutoff.toISOString().slice(0, 10);

        const counts = {};
        for (const sched of schedules) {
          if (sched.date < cutoffStr) continue;
          for (const assign of (sched.assignments || [])) {
            for (const sid of (assign.staffIds || [])) {
              counts[sid] = (counts[sid] || 0) + 1;
            }
          }
        }
        return counts;
      },

      getRecentAreasByStaff(days = 7) {
        const schedules = ScheduleModel.getAll();
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - days);
        const cutoffStr = cutoff.toISOString().slice(0, 10);

        const map = {};
        for (const sched of schedules) {
          if (sched.date < cutoffStr) continue;
          for (const assign of (sched.assignments || [])) {
            for (const sid of (assign.staffIds || [])) {
              if (!map[sid]) map[sid] = new Set();
              map[sid].add(assign.areaId);
            }
          }
        }
        return map;
      },
    };

    // â”€â”€â”€ åˆå§‹åŒ–é è¨­è³‡æ–™ï¼ˆå«ç‰ˆæœ¬æª¢æŸ¥ï¼‰ â”€â”€â”€
    async function initializeDefaultData() {
      const savedVer = parseInt(localStorage.getItem(STORAGE_KEYS.DATA_VER) || '0');

      // è‹¥ç‰ˆæœ¬å·²ç¶“ç¬¦åˆï¼Œç›´æ¥çµæŸ
      if (savedVer >= DATA_VERSION) {
        return;
      }

      // ç‰ˆæœ¬ä¸åŒ â†’ å˜—è©¦å¾ä¼ºæœå™¨å–å¾—é è¨­è³‡æ–™
      try {
        const resp = await fetch('./config/default_data.json?v=' + Date.now());
        if (resp.ok) {
          const data = await resp.json();

          // æˆåŠŸå–å¾—é è¨­è³‡æ–™ï¼Œé€™æ‰æ¸…ç©ºèˆŠè³‡æ–™ä¸¦è¦†è“‹
          console.log('è³‡æ–™ç‰ˆæœ¬å‡ç´š v' + savedVer + ' â†’ v' + DATA_VERSION + 'ï¼Œå·²å¾ä¼ºæœå™¨è¼‰å…¥é è¨­è³‡æ–™ã€‚');
          Object.values(STORAGE_KEYS).forEach(key => localStorage.removeItem(key));

          if (data.staff) StaffModel.save(data.staff);
          if (data.areas) AreaModel.save(data.areas);
          if (data.plannerRotation) PlannerModel.save(data.plannerRotation);

          localStorage.setItem(STORAGE_KEYS.DATA_VER, String(DATA_VERSION));
        } else {
          throw new Error('ä¼ºæœå™¨å›å‚³ç‹€æ…‹ç•°å¸¸');
        }
      } catch (e) {
        // å–å¾—å¤±æ•— (ä¾‹å¦‚åœ¨ file:// ä¸‹)
        console.warn('ç„¡æ³•é€£ç·šè‡³ä¼ºæœå™¨è¼‰å…¥é è¨­è³‡æ–™:', e.message);

        // å¦‚æœç›®å‰å·²ç¶“æœ‰æ‰‹å‹•åŒ¯å…¥çš„äººå“¡è³‡æ–™ï¼Œæˆ‘å€‘å°±ç›´æ¥æŠŠç‰ˆæœ¬è™Ÿå‡ä¸Šå»ï¼Œä¸è¦å†å˜—è©¦é‡ç½®
        if (StaffModel.getAll().length > 0) {
          console.log('åµæ¸¬åˆ°å·²æœ‰æœ¬åœ°è³‡æ–™ï¼Œåœæ­¢é‡ç½®é‚è¼¯ä¸¦æ›´æ–°ç‰ˆæœ¬è™Ÿè‡³ v' + DATA_VERSION);
          localStorage.setItem(STORAGE_KEYS.DATA_VER, String(DATA_VERSION));
        }
      }
    }
  </script>
  <script>// program/scheduler.js â€” æ ¸å¿ƒæ’ç­æ¼”ç®—æ³•

    // â”€â”€â”€ ç¢ºå®šæ€§éš¨æ©Ÿç”¢ç”Ÿå™¨ (LCG) â”€â”€â”€
    class SeededRandom {
      constructor(seed) {
        this.seed = seed || 12345;
      }
      next() {
        this.seed = (this.seed * 9301 + 49297) % 233280;
        return this.seed / 233280;
      }
    }

    const Scheduler = {
      generate(presentStaffIds, dateStr, options = {}) {
        const {
          isHolidayTomorrow = false,
          enabledOptionalAreas = [],
          plannerId = null,
          lockedAssignments = [],
          lockedStaffIds = [],
        } = options;

        // â”€â”€ åˆå§‹åŒ–ç¨®å­ â”€â”€
        const sortedPresentIds = [...presentStaffIds].sort().join(',');
        const seedInput = dateStr + sortedPresentIds;
        let seed = 5381;
        for (let i = 0; i < seedInput.length; i++) {
          seed = ((seed << 5) + seed) + seedInput.charCodeAt(i);
        }
        const rng = new SeededRandom(Math.abs(seed));

        const allAreas = AreaModel.getAll();
        const allStaff = StaffModel.getAll();
        const staffMap = {};
        allStaff.forEach(s => (staffMap[s.id] = s));

        const cleaningStaffIds = presentStaffIds.filter(id => id !== plannerId);
        const assignCounts = HistoryModel.getAssignmentCounts(14);
        const recentAreas = HistoryModel.getRecentAreasByStaff(7);
        const availablePool = new Set(cleaningStaffIds.filter(id => !lockedStaffIds.includes(id)));

        let assignments = [...lockedAssignments.map(a => ({ ...a, staffIds: [...a.staffIds] }))];
        const lockedAreaIds = new Set(lockedAssignments.map(a => a.areaId));
        const skippedAreas = [];
        const warnings = [];

        const dailyAreas = allAreas.filter(a => a.priority === 'daily' && !lockedAreaIds.has(a.id));
        const flexibleAreas = allAreas.filter(a => a.priority === 'flexible' && !lockedAreaIds.has(a.id));
        const optionalAreas = allAreas.filter(a => a.priority === 'optional' && !lockedAreaIds.has(a.id));

        // â”€â”€ éšæ®µ 1ï¼šå¿…æƒå€åŸŸ (å¼·æ€§åˆ¥é™åˆ¶) â”€â”€
        for (const area of dailyAreas.filter(a => a.genderRestriction !== 'none')) {
          const effectiveMax = (area.holidayBoost && isHolidayTomorrow) ? area.maxPeople : undefined;
          const result = this._assignArea(area, availablePool, staffMap, assignCounts, recentAreas, rng, effectiveMax);
          if (result.staffIds.length > 0) {
            assignments.push({ areaId: area.id, staffIds: result.staffIds });
            result.staffIds.forEach(id => availablePool.delete(id));
          } else {
            warnings.push('âš ï¸ ' + area.name + 'ï¼šç„¡æ³•å®‰æ’ç¬¦åˆæ¢ä»¶çš„äººå“¡');
          }
        }

        // â”€â”€ éšæ®µ 2ï¼šå¿…æƒå€åŸŸ (ç„¡æ€§åˆ¥é™åˆ¶) â”€â”€
        for (const area of dailyAreas.filter(a => a.genderRestriction === 'none')) {
          const result = this._assignArea(area, availablePool, staffMap, assignCounts, recentAreas, rng);
          if (result.staffIds.length > 0) {
            assignments.push({ areaId: area.id, staffIds: result.staffIds });
            result.staffIds.forEach(id => availablePool.delete(id));
          } else {
            warnings.push('âš ï¸ ' + area.name + 'ï¼šäººå“¡ä¸è¶³ï¼Œç„¡æ³•å®‰æ’å¿…æƒå€åŸŸ');
          }
        }

        // â”€â”€ éšæ®µ 3ï¼šå½ˆæ€§å€åŸŸ (å« a16 å„ªå…ˆé») â”€â”€
        const sortedFlexible = flexibleAreas.sort((a, b) => {
          if (a.id === 'a16') return -1;
          if (b.id === 'a16') return 1;
          return (a.order || 0) - (b.order || 0);
        });

        for (const area of sortedFlexible) {
          if (availablePool.size === 0) { skippedAreas.push(area.id); continue; }
          const result = this._assignArea(area, availablePool, staffMap, assignCounts, recentAreas, rng);
          if (result.staffIds.length > 0) {
            assignments.push({ areaId: area.id, staffIds: result.staffIds });
            result.staffIds.forEach(id => availablePool.delete(id));
          } else {
            skippedAreas.push(area.id);
          }
        }

        // â”€â”€ éšæ®µ 4ï¼šå¯é¸å€åŸŸ â”€â”€
        for (const area of optionalAreas) {
          if (!enabledOptionalAreas.includes(area.id) || availablePool.size === 0) {
            skippedAreas.push(area.id);
            continue;
          }
          // å„ªåŒ–ï¼šå°æ–¼å‹¾é¸çš„å¯é¸å€åŸŸï¼Œå³ä¾¿ç¸½äººæ•¸ä¸å¤šï¼Œä¹Ÿè¦å˜—è©¦åˆ†é…ï¼ˆåœ¨ _decideHeadcount æœƒçµ¦äºˆ minPeopleï¼‰
          const result = this._assignArea(area, availablePool, staffMap, assignCounts, recentAreas, rng);
          if (result.staffIds.length > 0) {
            assignments.push({ areaId: area.id, staffIds: result.staffIds });
            result.staffIds.forEach(id => availablePool.delete(id));
          } else {
            skippedAreas.push(area.id);
          }
        }

        // â”€â”€ éšæ®µ 5ï¼šOverfill å¼·åˆ¶åˆ†é… (ä¾ç©ºé–“å¤§å°å„ªå…ˆå¢æ´) â”€â”€
        if (availablePool.size > 0) {
          const remainingStaff = [...availablePool];
          const scoredRemaining = remainingStaff.map(id => ({ id, score: rng.next() }));
          scoredRemaining.sort((a, b) => a.score - b.score);

          // å®šç¾©å„ªå…ˆå¢æ´å€åŸŸ (äº‹å‹™æ‰€ a9, 2Fé™½å° a4)
          const priorityOverflowIds = ['a9', 'a4'];

          const getExpandableTargets = (ignoreMax = false) => {
            return assignments.filter(a => {
              const area = allAreas.find(ar => ar.id === a.areaId);
              if (!area) return false;
              // ç”·å¥³å»æ‰€åš´æ ¼é™åˆ¶ä¸å¾—è¶…é maxPeople (2äºº)
              if (area.name.includes('å»')) {
                return a.staffIds.length < area.maxPeople;
              }
              return ignoreMax || a.staffIds.length < area.maxPeople;
            }).sort((a, b) => {
              const aPri = priorityOverflowIds.includes(a.areaId) ? 0 : 1;
              const bPri = priorityOverflowIds.includes(b.areaId) ? 0 : 1;
              if (aPri !== bPri) return aPri - bPri;
              const arA = allAreas.find(ar => ar.id === a.areaId);
              const arB = allAreas.find(ar => ar.id === b.areaId);
              return (arA?.order || 99) - (arB?.order || 99);
            });
          };

          let assignIdx = 0;
          for (const item of scoredRemaining) {
            const staffId = item.id;
            let validTargets = getExpandableTargets(false);

            if (validTargets.length === 0) {
              validTargets = getExpandableTargets(true);
            }

            if (validTargets.length === 0 && allAreas.length > 0) {
              assignments.push({ areaId: allAreas[0].id, staffIds: [] });
              validTargets = getExpandableTargets(true);
            }

            if (validTargets.length === 0) continue;

            const s = staffMap[staffId];
            let foundTarget = null;

            // æ€§åˆ¥ç›¸å®¹æ€§æª¢æŸ¥
            const checkCompatibility = (targetAssignment, staffGender) => {
              const area = allAreas.find(ar => ar.id === targetAssignment.areaId);
              if (!area) return false;

              // 1. å¥³å»ï¼šåš´æ ¼ç¦æ­¢ç”·ç”Ÿé€²å…¥
              if (area.genderRestriction === 'female' && staffGender === 'male') {
                return false;
              }

              // 2. ç”·å»ï¼šä¸å…è¨±ç”·å¥³æ··æƒ
              if (area.genderRestriction === 'malePreferred') {
                const hasMale = targetAssignment.staffIds.some(id => staffMap[id].gender === 'male');
                const hasFemale = targetAssignment.staffIds.some(id => staffMap[id].gender === 'female');

                if (staffGender === 'female' && hasMale) return false;
                if (staffGender === 'male' && hasFemale) return false;
              }

              return true;
            };

            // å„ªå…ˆå°‹æ‰¾ç¬¦åˆæ€§åˆ¥ç›¸å®¹æ€§çš„å€åŸŸ
            for (let i = 0; i < validTargets.length; i++) {
              const t = validTargets[(assignIdx + i) % validTargets.length];
              if (checkCompatibility(t, s.gender)) {
                foundTarget = t;
                assignIdx = assignIdx + i + 1;
                break;
              }
            }

            // çµ•å°é˜²å‘†ï¼šè‹¥ç›®å‰ validTargets çš†ä¸ç¬¦åˆæ€§åˆ¥è¦å‰‡ï¼Œå‰‡å°‹æ‰¾ç„¡æ€§åˆ¥é™åˆ¶çš„å€åŸŸå¼·åˆ¶æ”¾å…¥
            if (!foundTarget) {
              const safeArea = allAreas.find(ar => ar.genderRestriction === 'none') || allAreas[0];
              let safeAssignment = assignments.find(a => a.areaId === safeArea.id);
              if (!safeAssignment) {
                safeAssignment = { areaId: safeArea.id, staffIds: [] };
                assignments.push(safeAssignment);
              }
              foundTarget = safeAssignment;
            }

            foundTarget.staffIds.push(staffId);
          }
        }

        const areaOrderMap = {};
        allAreas.forEach(a => areaOrderMap[a.id] = a.order);
        assignments.sort((a, b) => (areaOrderMap[a.areaId] || 99) - (areaOrderMap[b.areaId] || 99));

        return { assignments, skippedAreas, warnings };
      },

      _assignArea(area, availablePool, staffMap, assignCounts, recentAreas, rng, forceMax) {
        const poolArr = [...availablePool];
        let eligible = poolArr.filter(id => {
          const s = staffMap[id];
          if (!s) return false;
          if (s.floorRestriction && area.floor !== 0 && s.floorRestriction !== area.floor) return false;
          if (s.excludeAreas && s.excludeAreas.includes(area.id)) return false;
          return true;
        });

        if (area.genderRestriction === 'female') {
          eligible = eligible.filter(id => staffMap[id]?.gender === 'female');
        } else if (area.genderRestriction === 'malePreferred') {
          const males = eligible.filter(id => staffMap[id]?.gender === 'male');
          if (males.length > 0) eligible = males;
        }

        if (eligible.length === 0) return { staffIds: [] };

        // ç¢ºå®šæ€§æ’åº
        const scored = eligible.map(id => ({
          id,
          randomFactor: rng.next(),
          recent: recentAreas[id]?.has(area.id) ? 1 : 0,
          count: assignCounts[id] || 0
        }));

        scored.sort((a, b) => {
          if (a.recent !== b.recent) return a.recent - b.recent;
          if (a.count !== b.count) return a.count - b.count;
          return a.randomFactor - b.randomFactor;
        });

        const num = this._decideHeadcount(area, scored.length, availablePool.size, forceMax);
        return { staffIds: scored.slice(0, num).map(c => c.id) };
      },

      _decideHeadcount(area, candidateCount, totalAvailable, forceMax) {
        const { minPeople, maxPeople } = area;
        if (forceMax) return Math.min(forceMax, candidateCount);
        if (candidateCount <= minPeople) return Math.min(candidateCount, minPeople);

        // ä¾ç¸½äººæ•¸èª¿æ•´åˆ†é…é‡
        if (totalAvailable >= 20) return Math.min(maxPeople, candidateCount);

        // å¦‚æœæ˜¯é‡è¦å€åŸŸæˆ–å¯é¸å€åŸŸå·²å•Ÿç”¨ï¼Œå³ä¾¿ç¸½äººæ•¸ä¸å¤šä¹Ÿè‡³å°‘çµ¦äºˆ minPeople
        return Math.min(minPeople, candidateCount);
      },
    };
  </script>
  <script>// program/planner.js â€” è² è²¬äººè¼ªå€¼èˆ‡ä»£ç†æ©Ÿåˆ¶

    const PlannerService = {
      /**
       * å–å¾—æœ¬é€±è² è²¬äººï¼ˆå«ä»£ç†åˆ¤æ–·ï¼‰
       */
      getTodayPlanner(presentStaffIds) {
        const result = PlannerModel.getCurrentPlanner(presentStaffIds);
        if (!result) return null;

        const planner = StaffModel.getById(result.id);
        const original = StaffModel.getById(result.originalId);

        return {
          id: result.id,
          name: planner ? planner.name : 'æœªçŸ¥',
          isDeputy: result.isDeputy,
          originalId: result.originalId,
          originalName: original ? original.name : 'æœªçŸ¥',
        };
      },

      advanceToNextWeek() {
        PlannerModel.advanceWeek();
      },

      getRotationOverview() {
        const rot = PlannerModel.get();
        return rot.planners.map((pid, idx) => {
          const staff = StaffModel.getById(pid);
          // ä»£ç†äºº = ä¸‹ä¸€ä½
          const nextIdx = (idx + 1) % rot.planners.length;
          const deputy = StaffModel.getById(rot.planners[nextIdx]);

          return {
            index: idx,
            isCurrent: idx === rot.currentIndex % rot.planners.length,
            staffId: pid,
            staffName: staff ? staff.name : 'æœªçŸ¥',
            deputyName: deputy ? deputy.name : 'ç„¡',
          };
        });
      },

      updateRotation(plannerIds) {
        const rot = PlannerModel.get();
        rot.planners = plannerIds;
        if (rot.currentIndex >= plannerIds.length) rot.currentIndex = 0;
        PlannerModel.save(rot);
      },

      setCurrentIndex(index) {
        const rot = PlannerModel.get();
        rot.currentIndex = index;
        PlannerModel.save(rot);
      },
    };
  </script>
  <script>// program/data-io.js â€” JSON åŒ¯å‡º/åŒ¯å…¥åŠŸèƒ½

    const DataIO = {
      exportAll() {
        const data = {
          version: 2,
          exportedAt: new Date().toISOString(),
          staff: StaffModel.getAll(),
          areas: AreaModel.getAll(),
          plannerRotation: PlannerModel.get(),
          schedules: ScheduleModel.getAll(),
        };

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'cleaning_backup_' + new Date().toISOString().slice(0, 10) + '.json';
        a.click();
        URL.revokeObjectURL(url);
      },

      importAll(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = JSON.parse(e.target.result);
              if (!data.staff || !data.areas) {
                reject(new Error('æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º'));
                return;
              }
              if (data.staff) StaffModel.save(data.staff);
              if (data.areas) AreaModel.save(data.areas);
              if (data.plannerRotation) PlannerModel.save(data.plannerRotation);
              if (data.schedules) saveData(STORAGE_KEYS.SCHEDULES, data.schedules);

              // åŒ¯å…¥å¾Œè‡ªå‹•æ›´æ–°ç‰ˆæœ¬è™Ÿï¼Œé˜²æ­¢ initializeDefaultData èª¤åˆª
              localStorage.setItem(STORAGE_KEYS.DATA_VER, String(DATA_VERSION));

              resolve({
                staffCount: data.staff?.length || 0,
                areaCount: data.areas?.length || 0,
                scheduleCount: data.schedules?.length || 0,
              });
            } catch (err) {
              reject(new Error('JSON è§£æå¤±æ•—: ' + err.message));
            }
          };
          reader.onerror = () => reject(new Error('æª”æ¡ˆè®€å–å¤±æ•—'));
          reader.readAsText(file);
        });
      },

      clearAll() {
        Object.values(STORAGE_KEYS).forEach(key => localStorage.removeItem(key));
      },
    };
  </script>
  <script>// program/app.js â€” UI æ§åˆ¶å™¨

    // â”€â”€â”€ æ’ç­ç‹€æ…‹ç®¡ç† â”€â”€â”€
    let currentScheduleState = null;
    let sessionPresentStaffIds = null;  // æš«å­˜ç›®å‰çš„å‹¾é¸äººå“¡
    let sessionOptionalAreaIds = null;  // æš«å­˜ç›®å‰çš„å€åŸŸå‹¾é¸

    // â”€â”€â”€ Toast â”€â”€â”€
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = 'toast ' + type;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // â”€â”€â”€ Modal â”€â”€â”€
    function openModal(html) {
      const overlay = document.getElementById('modalOverlay');
      document.getElementById('modalContent').innerHTML = html;
      overlay.classList.add('active');
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('active');
    }

    document.getElementById('modalOverlay').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeModal();
    });

    // â”€â”€â”€ Tab åˆ‡æ› â”€â”€â”€
    document.getElementById('tabNav').addEventListener('click', (e) => {
      const btn = e.target.closest('.tab-btn');
      if (!btn) return;
      const tab = btn.dataset.tab;

      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('panel-' + tab).classList.add('active');

      if (tab === 'staff') renderStaffTable();
      if (tab === 'areas') renderAreaTable();
      if (tab === 'rotation') renderRotation();
      if (tab === 'history') renderHistory();
      if (tab === 'schedule') refreshSchedulePanel();
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TAB 1: æ¯æ—¥æ’ç­
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function refreshSchedulePanel() {
      renderStaffCheckboxes();
      renderOptionalToggles();
      updatePlannerBanner();
      updatePresentCount();
    }

    const dateInput = document.getElementById('scheduleDate');
    dateInput.value = new Date().toISOString().slice(0, 10);

    document.getElementById('todayBtn').addEventListener('click', () => {
      dateInput.value = new Date().toISOString().slice(0, 10);
      currentScheduleState = null;
      checkExistingSchedule();
    });

    dateInput.addEventListener('change', () => {
      currentScheduleState = null;
      sessionPresentStaffIds = null;  // é‡ç½®ï¼Œè®“ refresh æ™‚é‡æ–°åµæ¸¬è©²æ—¥æœŸçš„ç´€éŒ„æˆ–é è¨­å€¼
      sessionOptionalAreaIds = null;
      refreshSchedulePanel();
      checkExistingSchedule();
    });

    function checkExistingSchedule() {
      const existing = ScheduleModel.getByDate(dateInput.value);
      if (existing) {
        // å„ªå…ˆæ›´æ–° Session ç‹€æ…‹
        sessionPresentStaffIds = existing.presentStaff || [];
        sessionOptionalAreaIds = existing.enabledOptionalAreas || []; // å‡è¨­èˆŠè³‡æ–™ç„¡æ­¤æ¬„ä½å‰‡ç‚ºç©º

        renderStaffCheckboxes();
        renderOptionalToggles();
        updatePresentCount();
        renderScheduleResult(existing.assignments, existing.skippedAreas || [], []);

        // æ›´æ–°çµæœå¿«å–
        currentScheduleState = {
          assignments: existing.assignments,
          skippedAreas: existing.skippedAreas,
          presentIds: [...sessionPresentStaffIds],
          plannerId: existing.planner,
          enabledOptionalAreas: [...sessionOptionalAreaIds],
          isHolidayTomorrow: false // ç„¡æ³•å¾æ­·å²é‚„åŸæ­¤é …ï¼Œé è¨­ false
        };

        document.getElementById('saveScheduleBtn').style.display = '';
        document.getElementById('printBtn').style.display = '';
        document.getElementById('addLateBtn').style.display = '';

        showToast('å·²è¼‰å…¥ ' + dateInput.value + ' çš„æ’ç­ç´€éŒ„', 'info');
      } else {
        // è‹¥ç„¡ç´€éŒ„ï¼Œå‰‡äº¤ç”± refreshSchedulePanel (å›  date è®Šå‹•æœƒè§¸ç™¼ refresh) è™•ç†åˆå§‹åŒ–
        renderScheduleResult([], [], []);
        document.getElementById('saveScheduleBtn').style.display = 'none';
        document.getElementById('printBtn').style.display = 'none';
        document.getElementById('addLateBtn').style.display = 'none';
      }
    }

    // äººå“¡å‹¾é¸æ¸…å–® (ä¾éƒ¨é–€åˆ†çµ„)
    function renderStaffCheckboxes() {
      const container = document.getElementById('staffCheckboxes');
      const staff = StaffModel.getActive();

      const departments = {};
      // é€™è£¡ä¸å†éœ€è¦å…§éƒ¨çš„ sortOrderï¼Œæ”¹ç”¨ä¸‹æ–¹çš„å…¨åŸŸå®šç¾©

      staff.forEach(s => {
        const dept = s.department || 'æœªåˆ†é¡';
        if (!departments[dept]) departments[dept] = [];
        departments[dept].push(s);
      });

      // è™•ç†åˆå§‹åŒ–
      if (sessionPresentStaffIds === null) {
        const existing = ScheduleModel.getByDate(dateInput.value);
        if (existing) {
          sessionPresentStaffIds = existing.presentStaff || [];
        } else {
          sessionPresentStaffIds = staff.filter(s => s.isDefault).map(s => s.id);
        }
      }

      let html = '';
      // èª¿æ•´éƒ¨é–€é †åºï¼šç®¡ç†éƒ¨ -> ç‡Ÿæ¥­éƒ¨ -> æ–°äº‹æ¥­éƒ¨ -> æŠ€è¡“éƒ¨
      const sortOrder = ['ç®¡ç†éƒ¨', 'ç‡Ÿæ¥­éƒ¨', 'æ–°äº‹æ¥­éƒ¨', 'æŠ€è¡“éƒ¨', 'å…¶ä»–', 'æœªåˆ†é¡'];

      // è‡ªå®šç¾©äººå“¡é †åº (éƒ¨é•·é™¤å¤–)
      const USER_SEQUENCE = ["s11", "s07", "s08", "s14", "s18", "s22", "s10", "s13", "s19", "s21", "s27", "s23", "s28", "s06", "s05", "s02", "s04", "s12", "s15", "s16", "s17", "s20", "s24", "s25", "s26"];

      const getStaffRank = (s) => {
        if (s.role === 'manager') return -1; // éƒ¨é•·æ°¸é æœ€å‰
        const idx = USER_SEQUENCE.indexOf(s.id);
        return idx === -1 ? 999 : idx;
      };

      const deptKeys = Object.keys(departments).sort((a, b) => {
        const idxA = sortOrder.indexOf(a);
        const idxB = sortOrder.indexOf(b);
        return (idxA === -1 ? 99 : idxA) - (idxB === -1 ? 99 : idxB);
      });

      deptKeys.forEach(dept => {
        // éƒ¨é–€å…§äººå“¡ä¾è‡ªå®šç¾© Rank æ’åº
        departments[dept].sort((a, b) => getStaffRank(a) - getStaffRank(b));

        html += '<div class="dept-group" style="width:100%; margin-bottom:12px;">';
        html += '<h4 style="font-size:0.85rem; color:var(--text-muted); border-bottom:1px solid var(--border); margin-bottom:8px; padding-bottom:4px;">' + dept + '</h4>';
        html += '<div class="checkbox-grid">';

        html += departments[dept].map(s => {
          const isSelected = sessionPresentStaffIds.includes(s.id);
          const roleTag = s.role === 'manager' ? '<span class="badge badge-warning" style="margin-left:4px;font-size:0.65rem;">éƒ¨é•·</span>' : '';
          const restrictTag = s.floorRestriction ? '<span class="badge badge-info" style="margin-left:4px;font-size:0.65rem;">é™' + s.floorRestriction + 'F</span>' : '';

          return '<label class="checkbox-item ' + (isSelected ? 'checked' : '') + '" data-id="' + s.id + '">' +
            '<input type="checkbox" ' + (isSelected ? 'checked' : '') + '>' +
            '<span class="checkbox-mark"></span>' +
            '<span class="checkbox-label">' + s.name + roleTag + restrictTag + '</span>' +
            '<span class="gender-badge ' + s.gender + '">' + (s.gender === 'male' ? 'â™‚' : 'â™€') + '</span>' +
            '</label>';
        }).join('');

        html += '</div></div>';
      });

      container.innerHTML = html;

      container.querySelectorAll('.checkbox-item').forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          item.classList.toggle('checked');
          const cb = item.querySelector('input');
          cb.checked = !cb.checked;

          // åŒæ­¥è‡³ Session
          sessionPresentStaffIds = getSelectedStaffIds();

          updatePresentCount();
          updatePlannerBanner();
        });
      });
    }

    function getSelectedStaffIds() {
      return [...document.querySelectorAll('#staffCheckboxes .checkbox-item.checked')].map(el => el.dataset.id);
    }

    function updatePresentCount() {
      const selected = getSelectedStaffIds();
      const allStaff = StaffModel.getAll();
      const staffMap = {};
      allStaff.forEach(s => staffMap[s.id] = s);

      const males = selected.filter(id => staffMap[id]?.gender === 'male');
      const females = selected.filter(id => staffMap[id]?.gender === 'female');

      document.getElementById('presentCount').textContent = selected.length;
      document.getElementById('maleCount').textContent = males.length;
      document.getElementById('femaleCount').textContent = females.length;
    }

    document.getElementById('selectAllStaff').addEventListener('click', () => {
      document.querySelectorAll('#staffCheckboxes .checkbox-item').forEach(item => {
        item.classList.add('checked');
        item.querySelector('input').checked = true;
      });
      sessionPresentStaffIds = getSelectedStaffIds();
      updatePresentCount();
      updatePlannerBanner();
    });

    document.getElementById('deselectAllStaff').addEventListener('click', () => {
      document.querySelectorAll('#staffCheckboxes .checkbox-item').forEach(item => {
        item.classList.remove('checked');
        item.querySelector('input').checked = false;
      });
      sessionPresentStaffIds = [];
      updatePresentCount();
      updatePlannerBanner();
    });

    document.getElementById('selectDefaultStaff').addEventListener('click', () => {
      const allStaff = StaffModel.getAll();
      const staffMap = {};
      allStaff.forEach(s => staffMap[s.id] = s);

      document.querySelectorAll('#staffCheckboxes .checkbox-item').forEach(item => {
        const id = item.dataset.id;
        const s = staffMap[id];
        if (s && s.isDefault) {
          item.classList.add('checked');
          item.querySelector('input').checked = true;
        } else {
          item.classList.remove('checked');
          item.querySelector('input').checked = false;
        }
      });
      sessionPresentStaffIds = getSelectedStaffIds();
      updatePresentCount();
      updatePlannerBanner();
    });

    function updatePlannerBanner() {
      const presentIds = getSelectedStaffIds();
      const planner = PlannerService.getTodayPlanner(presentIds.length > 0 ? presentIds : null);

      const nameEl = document.getElementById('plannerName');
      const noteEl = document.getElementById('deputyNote');

      if (planner) {
        nameEl.textContent = planner.name;
        if (planner.isDeputy) {
          noteEl.style.display = 'block';
          noteEl.textContent = 'ï¼ˆä»£ç† ' + planner.originalName + 'ï¼Œè² è²¬äººä»Šæ—¥æœªå‡ºå‹¤ï¼‰';
        } else {
          noteEl.style.display = 'none';
        }
      } else {
        nameEl.textContent = 'å°šæœªè¨­å®š';
        noteEl.style.display = 'none';
      }
    }

    document.getElementById('generateBtn').addEventListener('click', () => {
      const presentIds = getSelectedStaffIds();
      if (presentIds.length === 0) {
        showToast('è«‹å…ˆå‹¾é¸ä»Šæ—¥å‡ºå‹¤äººå“¡', 'error');
        return;
      }

      const isHolidayTomorrow = document.getElementById('holidayToggle').checked;
      const enabledOptionalAreas = [];
      document.querySelectorAll('.optional-area-toggle:checked').forEach(cb => {
        enabledOptionalAreas.push(cb.dataset.areaId);
      });

      const planner = PlannerService.getTodayPlanner(presentIds);
      const plannerId = planner ? planner.id : null;

      const result = Scheduler.generate(presentIds, dateInput.value, {
        isHolidayTomorrow,
        enabledOptionalAreas,
        plannerId,
      });

      currentScheduleState = {
        assignments: result.assignments,
        skippedAreas: result.skippedAreas,
        warnings: result.warnings,
        presentIds: [...presentIds],
        plannerId,
        isHolidayTomorrow,
        enabledOptionalAreas,
      };

      renderScheduleResult(result.assignments, result.skippedAreas, result.warnings);
      document.getElementById('saveScheduleBtn').style.display = '';
      document.getElementById('printBtn').style.display = '';
      document.getElementById('addLateBtn').style.display = '';

      showToast('æ’ç­å®Œæˆï¼å·²åˆ†é… ' + result.assignments.length + ' å€‹å€åŸŸ', 'success');
    });

    document.getElementById('addLateBtn').addEventListener('click', () => {
      if (!currentScheduleState) {
        showToast('è«‹å…ˆé€²è¡Œè‡ªå‹•æ’ç­', 'error');
        return;
      }

      const nowSelectedIds = getSelectedStaffIds();
      const prevIds = currentScheduleState.presentIds;
      const newIds = nowSelectedIds.filter(id => !prevIds.includes(id) && id !== currentScheduleState.plannerId);

      if (newIds.length === 0) {
        showToast('æ²’æœ‰æ–°å¢äººå“¡', 'info');
        return;
      }

      const lockedAssignments = [];
      const lockedStaffIds = [];
      for (const assign of currentScheduleState.assignments) {
        lockedAssignments.push(assign);
        lockedStaffIds.push(...assign.staffIds);
      }

      const allPresentIds = [...new Set([...prevIds, ...newIds])];
      const result = Scheduler.generate(allPresentIds, dateInput.value, {
        isHolidayTomorrow: currentScheduleState.isHolidayTomorrow,
        enabledOptionalAreas: currentScheduleState.enabledOptionalAreas,
        plannerId: currentScheduleState.plannerId,
        lockedAssignments,
        lockedStaffIds,
      });

      currentScheduleState.assignments = result.assignments;
      currentScheduleState.skippedAreas = result.skippedAreas;
      currentScheduleState.presentIds = allPresentIds;

      renderScheduleResult(result.assignments, result.skippedAreas, result.warnings);
      showToast('å·²è¿½åŠ äººå“¡ä¸¦æ›´æ–°åˆ†é…', 'success');
    });

    function renderScheduleResult(assignments, skippedAreas, warnings) {
      const container = document.getElementById('scheduleResult');
      const allStaff = StaffModel.getAll();
      const allAreas = AreaModel.getAll();
      const staffMap = {};
      allStaff.forEach(s => staffMap[s.id] = s);
      const areaMap = {};
      allAreas.forEach(a => areaMap[a.id] = a);

      const dateStr = dateInput.value;
      const dateObj = new Date(dateStr + 'T00:00:00');
      const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
      const presentIds = getSelectedStaffIds();
      const planner = PlannerService.getTodayPlanner(presentIds);

      let html = '<div style="margin-bottom:16px;">' +
        '<h3 style="font-size:1.1rem;font-weight:700;">ğŸ“… ' + dateStr + 'ï¼ˆé€±' + weekdays[dateObj.getDay()] + 'ï¼‰æ’ç­çµæœ</h3>';

      if (planner) {
        html += '<p style="font-size:0.85rem;color:var(--text-secondary);margin-top:4px;">æ’ç­è² è²¬äººï¼š<strong style="color:var(--accent);">' + planner.name + '</strong>ï¼ˆä¸åƒèˆ‡æƒåœ°ï¼‰';
        if (planner.isDeputy) html += ' <span style="color:var(--warning);">â€” ä»£ç† ' + planner.originalName + '</span>';
        html += '</p>';
      }
      html += '</div>';

      if (warnings && warnings.length > 0) {
        html += warnings.map(w => '<div class="warning-item">' + w + '</div>').join('');
      }

      if (assignments.length > 0) {
        html += assignments.map(a => {
          const area = areaMap[a.areaId];
          if (!area) return '';
          const staffChips = a.staffIds.map(sid => {
            const s = staffMap[sid];
            if (!s) return '';
            // åŠ å…¥æ‹–æ›³å±¬æ€§
            return `<span class="staff-chip ${s.gender}" draggable="true" ondragstart="handleDragStart(event, '${sid}', '${a.areaId}')" ondragend="handleDragEnd(event)">${s.name}</span>`;
          }).join('');

          const priorityClass = area.priority;
          const genderTag = area.genderRestriction !== 'none'
            ? '<span class="gender-badge ' + (area.genderRestriction === 'female' ? 'female' : 'male') + '" style="font-size:0.65rem;margin-left:4px;">' + (area.genderRestriction === 'female' ? 'â™€' : 'â™‚å„ªå…ˆ') + '</span>'
            : '';

          const isOverflow = a.staffIds.length > area.maxPeople;
          const overflowTag = isOverflow ? '<span style="font-size:0.7rem;color:var(--info);margin-left:6px;">(å¢æ´)</span>' : '';

          // å€åŸŸåŠ å…¥æ¥æ”¶æ‹–æ›³çš„äº‹ä»¶
          return `<div class="assignment-card" data-area-id="${a.areaId}" ondragover="handleDragOver(event)" ondragenter="handleDragEnter(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, '${a.areaId}')">` +
            `<div class="assignment-area">` +
            `<span class="priority-dot ${priorityClass}"></span>` +
            area.name + genderTag + overflowTag +
            `</div>` +
            `<div class="assignment-staff">${staffChips}</div>` +
            `</div>`;
        }).join('');
      } else {
        html += '<div class="empty-state">âš ï¸ å°šç„¡ä»»ä½•åˆ†é…çµæœ</div>';
      }

      if (skippedAreas && skippedAreas.length > 0) {
        const relevantSkipped = skippedAreas.filter(aId => {
          const area = areaMap[aId];
          return area && area.priority !== 'optional';
        });
        const optionalSkipped = skippedAreas.filter(aId => {
          const area = areaMap[aId];
          return area && area.priority === 'optional';
        });

        if (relevantSkipped.length > 0) {
          html += '<div style="margin-top:16px;"><h4 style="font-size:0.9rem;color:var(--text-muted);margin-bottom:8px;">â­ï¸ ä»Šæ—¥è·³éï¼ˆäººæ•¸ä¸è¶³ï¼‰</h4></div>';
          html += relevantSkipped.map(aId => {
            const area = areaMap[aId];
            return '<div class="skipped-area">â­ï¸ ' + (area ? area.name : aId) + '</div>';
          }).join('');
        }

        if (optionalSkipped.length > 0) {
          html += '<div style="margin-top:12px;"><h4 style="font-size:0.9rem;color:var(--text-muted);margin-bottom:8px;">ğŸ”˜ æœªå•Ÿç”¨çš„å¯é¸å€åŸŸ</h4></div>';
          html += optionalSkipped.map(aId => {
            const area = areaMap[aId];
            return '<div class="skipped-area" style="border-color:rgba(96,165,250,0.15);background:var(--info-bg);color:var(--info);">ğŸ”˜ ' + (area ? area.name : aId) + '</div>';
          }).join('');
        }
      }

      container.innerHTML = html;
    }

    document.getElementById('saveScheduleBtn').addEventListener('click', () => {
      const dateStr = dateInput.value;
      const presentIds = getSelectedStaffIds();
      const isHolidayTomorrow = document.getElementById('holidayToggle').checked;
      const enabledOptionalAreas = [];
      document.querySelectorAll('.optional-area-toggle:checked').forEach(cb => enabledOptionalAreas.push(cb.dataset.areaId));
      const planner = PlannerService.getTodayPlanner(presentIds);
      const plannerId = planner ? planner.id : null;
      const assignments = currentScheduleState ? currentScheduleState.assignments : Scheduler.generate(presentIds, dateStr, { isHolidayTomorrow, enabledOptionalAreas, plannerId }).assignments;

      ScheduleModel.save({
        date: dateStr,
        planner: plannerId,
        presentStaff: presentIds,
        enabledOptionalAreas: enabledOptionalAreas, // æ–°å¢ï¼šä¿å­˜å·²å•Ÿç”¨çš„å¯é¸å€åŸŸ
        assignments: assignments,
        skippedAreas: currentScheduleState ? currentScheduleState.skippedAreas : [],
      });
      showToast(dateStr + ' æ’ç­å·²å„²å­˜', 'success');
    });

    document.getElementById('printBtn').addEventListener('click', () => window.print());

    const DEFAULT_CHECKED_AREAS = ['a10', 'a12'];

    function renderOptionalToggles() {
      const areas = AreaModel.getAll().filter(a => a.priority === 'optional');
      const container = document.getElementById('optionalToggles');

      // åˆå§‹åŒ–å¯é¸å€åŸŸå‹¾é¸ç‹€æ…‹
      if (sessionOptionalAreaIds === null) {
        const existing = ScheduleModel.getByDate(dateInput.value);
        if (existing && existing.enabledOptionalAreas) {
          sessionOptionalAreaIds = existing.enabledOptionalAreas;
        } else {
          sessionOptionalAreaIds = [...DEFAULT_CHECKED_AREAS];
        }
      }

      if (areas.length === 0) {
        container.innerHTML = '';
        return;
      }
      container.innerHTML = areas.map(a => {
        const isChecked = sessionOptionalAreaIds.includes(a.id);
        return '<label class="checkbox-item ' + (isChecked ? 'checked' : '') + '" style="max-width:220px;">' +
          '<input type="checkbox" class="optional-area-toggle" data-area-id="' + a.id + '" ' + (isChecked ? 'checked' : '') + '>' +
          '<span class="checkbox-mark"></span>' +
          '<span class="checkbox-label">' + a.name + '</span>' +
          '</label>';
      }).join('');

      container.querySelectorAll('.checkbox-item').forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          item.classList.toggle('checked');
          const cb = item.querySelector('input');
          cb.checked = !cb.checked;

          // åŒæ­¥è‡³ Session
          sessionOptionalAreaIds = [...document.querySelectorAll('.optional-area-toggle:checked')].map(el => el.dataset.areaId);
        });
      });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TAB 2: äººå“¡ç®¡ç†
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // â”€â”€â”€ Drag and Drop é‚è¼¯ â”€â”€â”€
    let dragSrcStaffId = null;
    let dragSrcAreaId = null;

    window.handleDragStart = function (e, staffId, areaId) {
      dragSrcStaffId = staffId;
      dragSrcAreaId = areaId;
      e.target.classList.add('dragging');
      // å°‡è¢«æ‹–æ›³çš„è³‡æ–™æ”¾å…¥ dataTransfer (éå¿…è¦ï¼Œä½†æ¨™æº–åšæ³•)
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', staffId);
    };

    window.handleDragEnd = function (e) {
      e.target.classList.remove('dragging');
      document.querySelectorAll('.assignment-card.drag-over').forEach(el => el.classList.remove('drag-over'));
    };

    window.handleDragOver = function (e) {
      e.preventDefault(); // å¿…é ˆé˜»æ“‹é è¨­è¡Œç‚ºæ‰èƒ½è§¸ç™¼ drop
      e.dataTransfer.dropEffect = 'move';
    };

    window.handleDragEnter = function (e) {
      e.preventDefault();
      const card = e.target.closest('.assignment-card');
      if (card) {
        card.classList.add('drag-over');
      }
    };

    window.handleDragLeave = function (e) {
      const card = e.target.closest('.assignment-card');
      if (card) {
        // ç°¡å–®åˆ¤æ–·é¿å…å­å…ƒç´ é–ƒçˆ
        if (!card.contains(e.relatedTarget)) {
          card.classList.remove('drag-over');
        }
      }
    };

    window.handleDrop = function (e, targetAreaId) {
      e.preventDefault();
      const card = e.target.closest('.assignment-card');
      if (card) card.classList.remove('drag-over');

      if (!dragSrcStaffId || !dragSrcAreaId) return;
      if (dragSrcAreaId === targetAreaId) return; // åŸåœ°æ”¾ä¸‹ä¸è™•ç†

      if (!currentScheduleState || !currentScheduleState.assignments) {
        showToast('æ‰¾ä¸åˆ°æ’ç­è³‡æ–™', 'error');
        return;
      }

      // å°‹æ‰¾ä¾†æºèˆ‡ç›®æ¨™ Assignment
      const assignments = currentScheduleState.assignments;
      let srcAssignment = assignments.find(a => a.areaId === dragSrcAreaId);
      let dstAssignment = assignments.find(a => a.areaId === targetAreaId);

      // æ¥µç«¯é˜²å‘† (ä¸æ‡‰è©²ç™¼ç”Ÿ)
      if (!srcAssignment) return;
      if (!dstAssignment) {
        // ç›®æ¨™å¯èƒ½ç›®å‰æ²’äººè€Œä¸åœ¨ assignments é™£åˆ—ä¸­ï¼Œå°‡å…¶åŠ å…¥
        dstAssignment = { areaId: targetAreaId, staffIds: [] };
        assignments.push(dstAssignment);
      }

      // æª¢æŸ¥æ€§åˆ¥ç›¸å®¹æ€§ç­‰ (é›–ç„¶æ‹–æ›³æ˜¯æ‰‹å‹•è¦†è“‹ï¼Œä½†ç‚ºäº†é˜²æ­¢çŠ¯éŒ¯ï¼Œä¹Ÿå¯åšæç¤º)
      const staff = StaffModel.getById(dragSrcStaffId);
      const targetArea = AreaModel.getById(targetAreaId);

      if (targetArea && targetArea.genderRestriction === 'female' && staff.gender === 'male') {
        showToast('âš ï¸ éŒ¯èª¤ï¼šç”·åŒäº‹ä¸èƒ½æƒå¥³å»ï¼', 'error');
        return;
      }

      if (targetArea && targetArea.name.includes('å»') && dstAssignment.staffIds.length >= targetArea.maxPeople) {
        if (!confirm('âš ï¸ è­¦å‘Šï¼šè©²å»æ‰€å·²æœ‰ ' + dstAssignment.staffIds.length + ' äºº (ä¸Šé™ ' + targetArea.maxPeople + ' äºº)ï¼Œç¢ºå®šè¦æ”¾å…¥å—ï¼Ÿ')) {
          return;
        }
      }

      // å¾ä¾†æºç§»é™¤
      srcAssignment.staffIds = srcAssignment.staffIds.filter(id => id !== dragSrcStaffId);
      // åŠ å…¥ç›®æ¨™
      dstAssignment.staffIds.push(dragSrcStaffId);

      // å¦‚æœä¾†æºå€ç©ºäº†ï¼Œå¯ä»¥è¦–æƒ…æ³æ¸…ç†é™£åˆ—
      if (srcAssignment.staffIds.length === 0) {
        currentScheduleState.assignments = assignments.filter(a => a.areaId !== dragSrcAreaId);
      }

      // é‡ç¹ªç•«é¢
      renderScheduleResult(currentScheduleState.assignments, currentScheduleState.skippedAreas, currentScheduleState.warnings);
      showToast('å·²å°‡ ' + staff.name + ' ç§»è‡³ ' + targetArea.name, 'success');

      // æç¤ºå„²å­˜
      document.getElementById('saveScheduleBtn').classList.add('btn-primary');
      document.getElementById('saveScheduleBtn').classList.remove('btn-success');
      document.getElementById('saveScheduleBtn').innerHTML = 'ğŸ’¾ è¨˜å¾—å„²å­˜è®Šæ›´';

      dragSrcStaffId = null;
      dragSrcAreaId = null;
    };

    function renderStaffTable() {
      const staff = StaffModel.getAll();
      const tbody = document.getElementById('staffTableBody');
      if (staff.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><div class="empty-icon">ğŸ‘¥</div><p>å°šç„¡äººå“¡</p></td></tr>';
        return;
      }

      // ä¾éƒ¨é–€èˆ‡è·ç¨±æ’åº
      const sortOrder = ['ç®¡ç†éƒ¨', 'ç‡Ÿæ¥­éƒ¨', 'æ–°äº‹æ¥­éƒ¨', 'æŠ€è¡“éƒ¨', 'å…¶ä»–', 'æœªåˆ†é¡'];
      const USER_SEQUENCE = ["s11", "s07", "s08", "s14", "s18", "s22", "s10", "s13", "s19", "s21", "s27", "s23", "s28", "s06", "s05", "s02", "s04", "s12", "s15", "s16", "s17", "s20", "s24", "s25", "s26"];

      const getRank = (s) => {
        const dIdx = sortOrder.indexOf(s.department || 'æœªåˆ†é¡');
        const deptScore = (dIdx === -1 ? 99 : dIdx) * 1000;
        const roleScore = s.role === 'manager' ? -100 : 0;
        const seqIdx = USER_SEQUENCE.indexOf(s.id);
        const seqScore = seqIdx === -1 ? 900 : seqIdx;
        return deptScore + roleScore + seqScore;
      };

      const sortedStaff = [...staff].sort((a, b) => getRank(a) - getRank(b));

      tbody.innerHTML = sortedStaff.map(s => {
        const restrict = [];
        if (s.floorRestriction) restrict.push('é™' + s.floorRestriction + 'F');
        if (s.excludeAreas && s.excludeAreas.length > 0) {
          const areaNames = s.excludeAreas.map(aid => {
            const a = AreaModel.getById(aid);
            return a ? a.name : aid;
          });
          restrict.push('æ’é™¤:' + areaNames.join(','));
        }

        return '<tr>' +
          '<td>' + (s.department || 'æœªåˆ†é¡') + '</td>' +
          '<td><strong>' + s.name + '</strong>' + (restrict.length ? '<br><small style="color:var(--warning)">' + restrict.join(',') + '</small>' : '') + '</td>' +
          '<td><span class="gender-badge ' + s.gender + '">' + (s.gender === 'male' ? 'â™‚' : 'â™€') + '</span></td>' +
          '<td>' + (s.role === 'manager' ? '<span class="badge badge-warning">éƒ¨é•·</span>' : 'ä¸€èˆ¬') + '</td>' +
          '<td>' + (s.active ? 'åœ¨è·' : 'åœç”¨') + '</td>' +
          '<td>' + (s.isDefault ? 'æ˜¯' : 'å¦') + '</td>' +
          '<td class="actions">' +
          '<button class="btn-icon" onclick="editStaff(\'' + s.id + '\')">âœï¸</button>' +
          '<button class="btn-icon danger" onclick="deleteStaff(\'' + s.id + '\')">ğŸ—‘ï¸</button>' +
          '</td></tr>';
      }).join('');
    }

    document.getElementById('addStaffBtn').addEventListener('click', () => {
      const areasForExclude = AreaModel.getAll().map(a =>
        '<option value="' + a.id + '">' + a.name + '</option>'
      ).join('');

      openModal(
        '<div class="modal-header"><h3 class="modal-title">æ–°å¢äººå“¡</h3><button class="modal-close" onclick="closeModal()">âœ•</button></div>' +
        '<div class="form-group"><label>éƒ¨é–€</label><select class="form-select" id="modalStaffDept"><option value="ç®¡ç†éƒ¨">ç®¡ç†éƒ¨</option><option value="ç‡Ÿæ¥­éƒ¨">ç‡Ÿæ¥­éƒ¨</option><option value="æ–°äº‹æ¥­éƒ¨">æ–°äº‹æ¥­éƒ¨</option><option value="æŠ€è¡“éƒ¨" selected>æŠ€è¡“éƒ¨</option></select></div>' +
        '<div class="form-group"><label>å§“å</label><input class="form-input" id="modalStaffName" placeholder="è«‹è¼¸å…¥å§“å" autofocus></div>' +
        '<div class="form-row">' +
        '<div class="form-group"><label>æ€§åˆ¥</label><select class="form-select" id="modalStaffGender"><option value="male">â™‚ ç”·</option><option value="female">â™€ å¥³</option></select></div>' +
        '<div class="form-group"><label>è§’è‰²</label><select class="form-select" id="modalStaffRole"><option value="regular">ä¸€èˆ¬</option><option value="manager">éƒ¨é•·</option></select></div>' +
        '</div>' +
        '<div class="form-row">' +
        '<div class="form-group"><label>é è¨­æ¯æ—¥å‡ºå‹¤</label><select class="form-select" id="modalStaffDefault"><option value="true">æ˜¯</option><option value="false">å¦</option></select></div>' +
        '<div class="form-group"><label>æ¨“å±¤é™åˆ¶</label><select class="form-select" id="modalStaffFloor"><option value="">ç„¡é™åˆ¶</option><option value="1">åƒ… 1 æ¨“</option><option value="2">åƒ… 2 æ¨“</option></select></div>' +
        '</div>' +
        '<div class="form-group"><label>æ’é™¤å€åŸŸï¼ˆå¯å¤šé¸ï¼ŒæŒ‰ä½ Ctrlï¼‰</label><select class="form-select" id="modalStaffExclude" multiple style="height:100px;">' + areasForExclude + '</select></div>' +
        '<div class="modal-footer"><button class="btn btn-outline btn-sm" onclick="closeModal()">å–æ¶ˆ</button><button class="btn btn-primary btn-sm" onclick="saveNewStaff()">æ–°å¢</button></div>'
      );
    });

    window.saveNewStaff = function () {
      const name = document.getElementById('modalStaffName').value.trim();
      if (!name) { showToast('è«‹è¼¸å…¥å§“å', 'error'); return; }

      const floorVal = document.getElementById('modalStaffFloor').value;
      const excludeSel = document.getElementById('modalStaffExclude');
      const excludeAreas = [...excludeSel.selectedOptions].map(o => o.value);

      StaffModel.add({
        name,
        department: document.getElementById('modalStaffDept').value,
        gender: document.getElementById('modalStaffGender').value,
        role: document.getElementById('modalStaffRole').value,
        isDefault: document.getElementById('modalStaffDefault').value === 'true',
        floorRestriction: floorVal ? parseInt(floorVal) : null,
        excludeAreas,
      });

      closeModal();
      renderStaffTable();
      showToast('å·²æ–°å¢äººå“¡ï¼š' + name, 'success');
    };

    window.editStaff = function (id) {
      const s = StaffModel.getById(id);
      if (!s) return;

      const areasForExclude = AreaModel.getAll().map(a =>
        '<option value="' + a.id + '" ' + ((s.excludeAreas || []).includes(a.id) ? 'selected' : '') + '>' + a.name + '</option>'
      ).join('');

      const depts = ['ç®¡ç†éƒ¨', 'ç‡Ÿæ¥­éƒ¨', 'æ–°äº‹æ¥­éƒ¨', 'æŠ€è¡“éƒ¨'];
      const deptOptions = depts.map(d => '<option value="' + d + '" ' + (s.department === d ? 'selected' : '') + '>' + d + '</option>').join('');

      openModal(
        '<div class="modal-header"><h3 class="modal-title">ç·¨è¼¯äººå“¡</h3><button class="modal-close" onclick="closeModal()">âœ•</button></div>' +
        '<div class="form-group"><label>éƒ¨é–€</label><select class="form-select" id="modalStaffDept">' + deptOptions + '</select></div>' +
        '<div class="form-group"><label>å§“å</label><input class="form-input" id="modalStaffName" value="' + s.name + '"></div>' +
        '<div class="form-row">' +
        '<div class="form-group"><label>æ€§åˆ¥</label><select class="form-select" id="modalStaffGender"><option value="male" ' + (s.gender === 'male' ? 'selected' : '') + '>â™‚ ç”·</option><option value="female" ' + (s.gender === 'female' ? 'selected' : '') + '>â™€ å¥³</option></select></div>' +
        '<div class="form-group"><label>è§’è‰²</label><select class="form-select" id="modalStaffRole"><option value="regular" ' + (s.role !== 'manager' ? 'selected' : '') + '>ä¸€èˆ¬</option><option value="manager" ' + (s.role === 'manager' ? 'selected' : '') + '>éƒ¨é•·</option></select></div>' +
        '</div>' +
        '<div class="form-row">' +
        '<div class="form-group"><label>ç‹€æ…‹</label><select class="form-select" id="modalStaffActive"><option value="true" ' + (s.active ? 'selected' : '') + '>åœ¨è·</option><option value="false" ' + (!s.active ? 'selected' : '') + '>åœç”¨</option></select></div>' +
        '<div class="form-group"><label>é è¨­æ¯æ—¥å‡ºå‹¤</label><select class="form-select" id="modalStaffDefault"><option value="true" ' + (s.isDefault ? 'selected' : '') + '>æ˜¯</option><option value="false" ' + (!s.isDefault ? 'selected' : '') + '>å¦</option></select></div>' +
        '</div>' +
        '<div class="form-group"><label>æ¨“å±¤é™åˆ¶</label><select class="form-select" id="modalStaffFloor"><option value="">ç„¡é™åˆ¶</option><option value="1" ' + (s.floorRestriction === 1 ? 'selected' : '') + '>åƒ… 1 æ¨“</option><option value="2" ' + (s.floorRestriction === 2 ? 'selected' : '') + '>åƒ… 2 æ¨“</option></select></div>' +
        '<div class="form-group"><label>æ’é™¤å€åŸŸï¼ˆå¯å¤šé¸ï¼ŒæŒ‰ä½ Ctrlï¼‰</label><select class="form-select" id="modalStaffExclude" multiple style="height:100px;">' + areasForExclude + '</select></div>' +
        '<div class="modal-footer"><button class="btn btn-outline btn-sm" onclick="closeModal()">å–æ¶ˆ</button><button class="btn btn-primary btn-sm" onclick="updateStaff(\'' + id + '\')">å„²å­˜</button></div>'
      );
    };

    window.updateStaff = function (id) {
      const floorVal = document.getElementById('modalStaffFloor').value;
      const excludeSel = document.getElementById('modalStaffExclude');
      const excludeAreas = [...excludeSel.selectedOptions].map(o => o.value);

      StaffModel.update(id, {
        name: document.getElementById('modalStaffName').value.trim(),
        department: document.getElementById('modalStaffDept').value,
        gender: document.getElementById('modalStaffGender').value,
        role: document.getElementById('modalStaffRole').value,
        active: document.getElementById('modalStaffActive').value === 'true',
        isDefault: document.getElementById('modalStaffDefault').value === 'true',
        floorRestriction: floorVal ? parseInt(floorVal) : null,
        excludeAreas,
      });
      closeModal();
      renderStaffTable();
      if (document.querySelector('.tab-btn[data-tab="schedule"]').classList.contains('active')) {
        renderStaffCheckboxes(); // æ›´æ–°æ’ç­é é¢çš„äººå“¡åˆ†çµ„
      }
      showToast('äººå“¡å·²æ›´æ–°', 'success');
    };

    window.deleteStaff = function (id) {
      const s = StaffModel.getById(id);
      if (!s) return;
      if (!confirm('ç¢ºå®šåˆªé™¤ã€Œ' + s.name + 'ã€å—ï¼Ÿ')) return;
      StaffModel.remove(id);
      renderStaffTable();
      showToast('å·²åˆªé™¤ï¼š' + s.name, 'info');
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TAB 3: å€åŸŸç®¡ç†
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function renderAreaTable() {
      const areas = AreaModel.getAll();
      const tbody = document.getElementById('areaTableBody');

      if (areas.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><div class="empty-icon">ğŸ¢</div><p>å°šç„¡å€åŸŸ</p></td></tr>';
        return;
      }

      const priorityLabels = { daily: 'ğŸ”´ æ¯æ—¥å¿…æƒ', flexible: 'ğŸŸ¡ å½ˆæ€§', optional: 'ğŸ”µ å¯é¸' };
      const genderLabels = { none: 'ä¸é™', female: 'â™€ é™å¥³', malePreferred: 'â™‚ å„ªå…ˆç”·', male: 'â™‚ é™ç”·' };

      tbody.innerHTML = areas.map(a => {
        return '<tr>' +
          '<td><strong>' + a.name + '</strong></td>' +
          '<td>' + (a.floor === 0 ? 'å…¨' : a.floor + 'F') + '</td>' +
          '<td>' + (priorityLabels[a.priority] || a.priority) + '</td>' +
          '<td>' + (genderLabels[a.genderRestriction] || a.genderRestriction) + '</td>' +
          '<td>' + a.minPeople + '~' + a.maxPeople + ' äºº' + (a.holidayBoost ? ' <span class="badge badge-info" style="font-size:0.6rem;">å‡æ—¥+1</span>' : '') + '</td>' +
          '<td class="actions">' +
          '<button class="btn-icon" onclick="editArea(\'' + a.id + '\')" title="ç·¨è¼¯">âœï¸</button>' +
          '<button class="btn-icon danger" onclick="deleteArea(\'' + a.id + '\')" title="åˆªé™¤">ğŸ—‘ï¸</button>' +
          '</td></tr>';
      }).join('');
    }

    document.getElementById('addAreaBtn').addEventListener('click', () => {
      openModal(
        '<div class="modal-header"><h3 class="modal-title">æ–°å¢æ¸…æƒå€åŸŸ</h3><button class="modal-close" onclick="closeModal()">âœ•</button></div>' +
        '<div class="form-group"><label>å€åŸŸåç¨±</label><input class="form-input" id="modalAreaName" placeholder="ä¾‹ï¼š2æ¨“_æœƒè­°å®¤" autofocus></div>' +
        '<div class="form-row-3">' +
        '<div class="form-group"><label>æ¨“å±¤</label><select class="form-select" id="modalAreaFloor"><option value="0">å…¨æ¨“å±¤</option><option value="1">1 æ¨“</option><option value="2">2 æ¨“</option></select></div>' +
        '<div class="form-group"><label>å„ªå…ˆç´š</label><select class="form-select" id="modalAreaPriority"><option value="daily">æ¯æ—¥å¿…æƒ</option><option value="flexible">å½ˆæ€§</option><option value="optional">å¯é¸</option></select></div>' +
        '<div class="form-group"><label>æ€§åˆ¥é™å®š</label><select class="form-select" id="modalAreaGender"><option value="none">ä¸é™</option><option value="malePreferred">â™‚ å„ªå…ˆç”·</option><option value="female">â™€ åƒ…é™å¥³æ€§</option></select></div>' +
        '</div>' +
        '<div class="form-row-3">' +
        '<div class="form-group"><label>æœ€å°‘äººæ•¸</label><input class="form-input" id="modalAreaMin" type="number" min="1" max="10" value="1"></div>' +
        '<div class="form-group"><label>æœ€å¤šäººæ•¸</label><input class="form-input" id="modalAreaMax" type="number" min="1" max="10" value="1"></div>' +
        '<div class="form-group"><label>å‡æ—¥å‰åŠ äºº</label><select class="form-select" id="modalAreaHoliday"><option value="false">å¦</option><option value="true">æ˜¯</option></select></div>' +
        '</div>' +
        '<div class="modal-footer"><button class="btn btn-outline btn-sm" onclick="closeModal()">å–æ¶ˆ</button><button class="btn btn-primary btn-sm" onclick="saveNewArea()">æ–°å¢</button></div>'
      );
    });

    window.saveNewArea = function () {
      const name = document.getElementById('modalAreaName').value.trim();
      if (!name) { showToast('è«‹è¼¸å…¥å€åŸŸåç¨±', 'error'); return; }

      AreaModel.add({
        name,
        floor: parseInt(document.getElementById('modalAreaFloor').value),
        priority: document.getElementById('modalAreaPriority').value,
        genderRestriction: document.getElementById('modalAreaGender').value,
        minPeople: parseInt(document.getElementById('modalAreaMin').value) || 1,
        maxPeople: parseInt(document.getElementById('modalAreaMax').value) || 1,
        holidayBoost: document.getElementById('modalAreaHoliday').value === 'true',
      });

      closeModal();
      renderAreaTable();
      renderOptionalToggles();
      showToast('å·²æ–°å¢å€åŸŸï¼š' + name, 'success');
    };

    window.editArea = function (id) {
      const a = AreaModel.getById(id);
      if (!a) return;

      openModal(
        '<div class="modal-header"><h3 class="modal-title">ç·¨è¼¯å€åŸŸ</h3><button class="modal-close" onclick="closeModal()">âœ•</button></div>' +
        '<div class="form-group"><label>å€åŸŸåç¨±</label><input class="form-input" id="modalAreaName" value="' + a.name + '"></div>' +
        '<div class="form-row-3">' +
        '<div class="form-group"><label>æ¨“å±¤</label><select class="form-select" id="modalAreaFloor"><option value="0" ' + (a.floor === 0 ? 'selected' : '') + '>å…¨æ¨“å±¤</option><option value="1" ' + (a.floor === 1 ? 'selected' : '') + '>1 æ¨“</option><option value="2" ' + (a.floor === 2 ? 'selected' : '') + '>2 æ¨“</option></select></div>' +
        '<div class="form-group"><label>å„ªå…ˆç´š</label><select class="form-select" id="modalAreaPriority"><option value="daily" ' + (a.priority === 'daily' ? 'selected' : '') + '>æ¯æ—¥å¿…æƒ</option><option value="flexible" ' + (a.priority === 'flexible' ? 'selected' : '') + '>å½ˆæ€§</option><option value="optional" ' + (a.priority === 'optional' ? 'selected' : '') + '>å¯é¸</option></select></div>' +
        '<div class="form-group"><label>æ€§åˆ¥é™å®š</label><select class="form-select" id="modalAreaGender"><option value="none" ' + (a.genderRestriction === 'none' ? 'selected' : '') + '>ä¸é™</option><option value="malePreferred" ' + (a.genderRestriction === 'malePreferred' ? 'selected' : '') + '>â™‚ å„ªå…ˆç”·</option><option value="female" ' + (a.genderRestriction === 'female' ? 'selected' : '') + '>â™€ åƒ…é™å¥³æ€§</option></select></div>' +
        '</div>' +
        '<div class="form-row-3">' +
        '<div class="form-group"><label>æœ€å°‘äººæ•¸</label><input class="form-input" id="modalAreaMin" type="number" min="1" max="10" value="' + a.minPeople + '"></div>' +
        '<div class="form-group"><label>æœ€å¤šäººæ•¸</label><input class="form-input" id="modalAreaMax" type="number" min="1" max="10" value="' + a.maxPeople + '"></div>' +
        '<div class="form-group"><label>å‡æ—¥å‰åŠ äºº</label><select class="form-select" id="modalAreaHoliday"><option value="false" ' + (!a.holidayBoost ? 'selected' : '') + '>å¦</option><option value="true" ' + (a.holidayBoost ? 'selected' : '') + '>æ˜¯</option></select></div>' +
        '</div>' +
        '<div class="modal-footer"><button class="btn btn-outline btn-sm" onclick="closeModal()">å–æ¶ˆ</button><button class="btn btn-primary btn-sm" onclick="updateArea(\'' + id + '\')">å„²å­˜</button></div>'
      );
    };

    window.updateArea = function (id) {
      AreaModel.update(id, {
        name: document.getElementById('modalAreaName').value.trim(),
        floor: parseInt(document.getElementById('modalAreaFloor').value),
        priority: document.getElementById('modalAreaPriority').value,
        genderRestriction: document.getElementById('modalAreaGender').value,
        minPeople: parseInt(document.getElementById('modalAreaMin').value) || 1,
        maxPeople: parseInt(document.getElementById('modalAreaMax').value) || 1,
        holidayBoost: document.getElementById('modalAreaHoliday').value === 'true',
      });
      closeModal();
      renderAreaTable();
      renderOptionalToggles();
      showToast('å€åŸŸå·²æ›´æ–°', 'success');
    };

    window.deleteArea = function (id) {
      const a = AreaModel.getById(id);
      if (!a) return;
      if (!confirm('ç¢ºå®šåˆªé™¤ã€Œ' + a.name + 'ã€å—ï¼Ÿ')) return;
      AreaModel.remove(id);
      renderAreaTable();
      renderOptionalToggles();
      showToast('å·²åˆªé™¤ï¼š' + a.name, 'info');
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TAB 4 & 5 & 6 (Rotation, History, Data)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function renderRotation() {
      const overview = PlannerService.getRotationOverview();
      const container = document.getElementById('rotationList');

      if (overview.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ”„</div><p>å°šæœªè¨­å®šè¼ªå€¼é †åº</p></div>';
        return;
      }

      container.innerHTML = overview.map(item =>
        '<div class="rotation-item ' + (item.isCurrent ? 'current' : '') + '" onclick="PlannerService.setCurrentIndex(' + item.index + ');renderRotation();updatePlannerBanner();showToast(\'å·²åˆ‡æ›æœ¬é€±è² è²¬äººç‚º ' + item.staffName + '\',\'success\');">' +
        '<span class="rotation-index">' + (item.index + 1) + '</span>' +
        '<span class="rotation-name">' + item.staffName + '</span>' +
        (item.isCurrent ? '<span class="badge badge-success">æœ¬é€±</span>' : '') +
        '<span class="rotation-deputy">ä»£ç†äººï¼š' + item.deputyName + '</span>' +
        '</div>'
      ).join('');
    }

    document.getElementById('advanceWeekBtn').addEventListener('click', () => {
      PlannerService.advanceToNextWeek();
      renderRotation();
      updatePlannerBanner();
      showToast('å·²æ¨é€²è‡³ä¸‹ä¸€é€±', 'success');
    });

    function renderHistory() {
      const schedules = ScheduleModel.getRecent(30);
      const container = document.getElementById('historyList');
      const allStaff = StaffModel.getAll();
      const staffMap = {};
      allStaff.forEach(s => staffMap[s.id] = s);

      if (schedules.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“œ</div><p>å°šç„¡æ’ç­ç´€éŒ„</p></div>';
        return;
      }

      const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

      container.innerHTML = schedules.map(sched => {
        const areaCount = sched.assignments ? sched.assignments.length : 0;
        const staffCount = sched.presentStaff ? sched.presentStaff.length : 0;
        const plannerName = sched.planner && staffMap[sched.planner] ? staffMap[sched.planner].name : '-';
        const dateObj = new Date(sched.date + 'T00:00:00');

        return '<div class="history-item" onclick="loadHistorySchedule(\'' + sched.date + '\')">' +
          '<div>' +
          '<div class="history-date">' + sched.date + 'ï¼ˆé€±' + weekdays[dateObj.getDay()] + 'ï¼‰</div>' +
          '<div class="history-summary">å‡ºå‹¤ ' + staffCount + ' äºº Â· æ’å®š ' + areaCount + ' å€åŸŸ Â· è² è²¬äººï¼š' + plannerName + '</div>' +
          '</div>' +
          '<button class="btn-icon danger" onclick="event.stopPropagation();deleteHistory(\'' + sched.date + '\')" title="åˆªé™¤">ğŸ—‘ï¸</button>' +
          '</div>';
      }).join('');
    }

    window.loadHistorySchedule = function (dateStr) {
      const sched = ScheduleModel.getByDate(dateStr);
      if (!sched) return;

      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      document.querySelector('[data-tab="schedule"]').classList.add('active');
      document.getElementById('panel-schedule').classList.add('active');

      dateInput.value = dateStr;
      renderStaffCheckboxes();

      setTimeout(() => {
        document.querySelectorAll('#staffCheckboxes .checkbox-item').forEach(item => {
          const id = item.dataset.id;
          if (sched.presentStaff.includes(id)) {
            item.classList.add('checked');
            item.querySelector('input').checked = true;
          } else {
            item.classList.remove('checked');
            item.querySelector('input').checked = false;
          }
        });
        updatePresentCount();
        updatePlannerBanner();
        renderScheduleResult(sched.assignments, sched.skippedAreas || [], []);
      }, 50);
    };

    window.deleteHistory = function (dateStr) {
      if (!confirm('ç¢ºå®šåˆªé™¤ ' + dateStr + ' çš„æ’ç­ç´€éŒ„å—ï¼Ÿ')) return;
      ScheduleModel.remove(dateStr);
      renderHistory();
      showToast('å·²åˆªé™¤ ' + dateStr + ' çš„ç´€éŒ„', 'info');
    };

    document.getElementById('exportBtn').addEventListener('click', () => {
      DataIO.exportAll();
      showToast('è³‡æ–™å·²åŒ¯å‡º', 'success');
    });

    document.getElementById('importBtn').addEventListener('click', () => {
      document.getElementById('importFile').click();
    });

    document.getElementById('importFile').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const result = await DataIO.importAll(file);
        showToast('åŒ¯å…¥æˆåŠŸï¼š' + result.staffCount + ' äººã€' + result.areaCount + ' å€åŸŸã€' + result.scheduleCount + ' ç­†ç´€éŒ„', 'success');
        refreshSchedulePanel();
        renderOptionalToggles();
      } catch (err) {
        showToast(err.message, 'error');
      }
      e.target.value = '';
    });

    document.getElementById('clearAllBtn').addEventListener('click', () => {
      if (!confirm('âš ï¸ ç¢ºå®šæ¸…é™¤å…¨éƒ¨è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) return;
      if (!confirm('å†æ¬¡ç¢ºèªï¼šæ‰€æœ‰äººå“¡ã€å€åŸŸã€æ’ç­ç´€éŒ„éƒ½å°‡è¢«åˆªé™¤ï¼Ÿ')) return;
      DataIO.clearAll();
      showToast('æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤', 'info');
      refreshSchedulePanel();
      renderOptionalToggles();
    });

    document.getElementById('resetDefaultBtn').addEventListener('click', async () => {
      if (!confirm('ç¢ºå®šé‡ç½®ç‚ºé è¨­è³‡æ–™å—ï¼Ÿç¾æœ‰è³‡æ–™å°‡è¢«è¦†è“‹ã€‚')) return;
      DataIO.clearAll();
      localStorage.removeItem('cleaning_data_version');
      initializeInlineData();
      refreshSchedulePanel();
      renderOptionalToggles();
      showToast('å·²é‡ç½®ç‚ºé è¨­è³‡æ–™', 'success');
    });

    document.getElementById('holidayLabel').addEventListener('click', (e) => {
      e.preventDefault();
      const item = document.getElementById('holidayLabel');
      const cb = document.getElementById('holidayToggle');
      cb.checked = !cb.checked;
      item.classList.toggle('checked', cb.checked);
    });

    async function boot() {
      await initializeDefaultData();
      refreshSchedulePanel();
      renderOptionalToggles();
    }

    boot();
  </script>

</body>

</html>